<!doctype html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"> 
  <meta name="referrer" content="unsafe-url"> 
  <title>Используем SQLite в KPHP и PHP через FFI / Хабр</title> 
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }

    /* non-breaking hyphen */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/l/font?kit=KFOlCnqEu92Fr1MmEU9vBh0_IsHAlmrO6g&skey=ee881451c540fdec&v=v29) format('woff2');
      unicode-range: U+02011;
    }
  </style> 
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.961b6771.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.55ca5167.js" as="script">
  <link rel="preload" href="https://assets.habr.com/habr-web/css/app.d1834a6b.css" as="style">
  <link rel="preload" href="https://assets.habr.com/habr-web/js/app.69ba180e.js" as="script"> 
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.961b6771.css">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.d1834a6b.css"> 
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.2822d469ec31a56409ac330bbcf7fcbf.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script> 
  <script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/653677\/"},"headline":"Используем SQLite в KPHP и PHP через FFI","datePublished":"2022-03-11T17:53:06+03:00","dateModified":"2022-03-11T17:53:06+03:00","author":{"@type":"Person","name":"Искандер"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP. Создавать FFI пакеты &mdash; не просто. Под катом будут ответы на сл...","url":"https:\/\/habr.com\/ru\/post\/653677\/#post-content-body","about":["h_webdev","h_open_source","h_php","h_programming","h_sqlite","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/bo\/nc\/pi\/boncpiokbph5gehyjnsqycl_78i.png","https:\/\/habrastorage.org\/webt\/ys\/m6\/xe\/ysm6xens23eqrhj0h7_53khn8ni.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/452\/ef7\/ff0\/452ef7ff04ba330c1277db05bc368715.png"]}</script> 
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script> 
  <style>.grecaptcha-badge{visibility: hidden;}</style> 
  <meta name="habr-version" content="2.66.0"> 
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613">
  <meta data-vue-meta="ssr" property="fb:pages" content="472597926099084">
  <meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image">
  <meta data-vue-meta="ssr" name="twitter:site" content="@habr_com">
  <meta data-vue-meta="ssr" property="og:site_name" content="Хабр" data-vmid="og:site_name">
  <meta data-vue-meta="ssr" property="og:title" content="Используем SQLite в KPHP и PHP через FFI" data-vmid="og:title">
  <meta data-vue-meta="ssr" name="twitter:title" content="Используем SQLite в KPHP и PHP через FFI" data-vmid="twitter:title">
  <meta data-vue-meta="ssr" name="aiturec:title" content="Используем SQLite в KPHP и PHP через FFI" data-vmid="aiturec:title">
  <meta data-vue-meta="ssr" name="description" content="Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.
Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:

Как упростить..." data-vmid="description">
  <meta data-vue-meta="ssr" itemprop="description" content="Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.
Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:

Как упростить..." data-vmid="description:itemprop">
  <meta data-vue-meta="ssr" property="og:description" content="Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.
Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:

Как упростить..." data-vmid="og:description">
  <meta data-vue-meta="ssr" name="twitter:description" content="Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.
Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:

Как упростить..." data-vmid="twitter:description">
  <meta data-vue-meta="ssr" property="aiturec:description" content="Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.
Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:

Как упростить..." data-vmid="aiturec:description">
  <meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/" data-vmid="image:itemprop">
  <meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/" data-vmid="og:image">
  <meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width">
  <meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/" data-vmid="aiturec:image">
  <meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/" data-vmid="twitter:image">
  <meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/?format=vk" data-vmid="vk:image">
  <meta data-vue-meta="ssr" property="aiturec:item_id" content="653677" data-vmid="aiturec:item_id">
  <meta data-vue-meta="ssr" property="aiturec:datetime" content="2022-03-11T14:53:06.000Z" data-vmid="aiturec:datetime">
  <meta data-vue-meta="ssr" content="https://habr.com/ru/post/653677/" property="og:url" data-vmid="og:url">
  <meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type">
  <meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale">
  <meta data-vue-meta="ssr" name="keywords" content="kphp, php, sqlite, ffi, ksqlite"> 
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/653677/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss">
  <link data-vue-meta="ssr" href="https://habr.com/ru/post/653677/" rel="canonical" data-vmid="canonical">
  <link data-vue-meta="ssr" data-vmid="hreflang">
  <link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/653677/bc75c868bcb4bbc0256bca68d91ac4c8/" data-vmid="image:href"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44"> 
  <meta name="msapplication-TileColor" content="#629FBC"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"> 
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"> 
  <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"> 
  <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"> 
  <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"> 
  <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest"> 
 </head> 
 <body> 
  <div id="app" data-server-rendered="true" data-async-called="true">
   <div class="tm-layout__wrapper">
    <!----> 
    <div></div> <!----> 
    <header class="tm-header">
     <div class="tm-page-width">
      <div class="tm-header__container">
       <!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru">
         <svg height="16" width="16" class="tm-svg-img tm-header__icon">
          <title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use>
         </svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> 
       <div class="tm-dropdown tm-header__projects">
        <div class="tm-dropdown__head">
         <button class="tm-header__dropdown-toggle">
          <svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown">
           <title>Открыть список</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#arrow-down"></use>
          </svg></button>
        </div> <!---->
       </div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn"> Как стать автором </a> 
       <div class="tm-feature tm-header__feature tm-feature_variant-inline">
        <!---->
       </div> <!----> <!---->
      </div>
     </div>
    </header> 
    <div class="tm-layout">
     <div class="tm-page-progress-bar"></div> 
     <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky">
      <div class="tm-page-width">
       <div class="tm-base-layout__header-wrapper">
        <div class="tm-main-menu">
         <div class="tm-main-menu__section">
          <nav class="tm-main-menu__section-content">
           <!----> <a href="/ru/flows/all" class="tm-main-menu__item"> Все потоки </a> <a href="/ru/flows/develop/" class="tm-main-menu__item"> Разработка </a><a href="/ru/flows/admin/" class="tm-main-menu__item"> Администрирование </a><a href="/ru/flows/design/" class="tm-main-menu__item"> Дизайн </a><a href="/ru/flows/management/" class="tm-main-menu__item"> Менеджмент </a><a href="/ru/flows/marketing/" class="tm-main-menu__item"> Маркетинг </a><a href="/ru/flows/popsci/" class="tm-main-menu__item"> Научпоп </a>
          </nav>
         </div>
        </div> 
        <div class="tm-header-user-menu tm-base-layout__user-menu">
         <a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search">
          <svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark">
           <title>Поиск</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#search"></use>
          </svg></a> <!----> <!----> <!----> 
         <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop">
          <div class="tm-dropdown">
           <div class="tm-dropdown__head">
            <svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon">
             <title>Профиль</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#header-user"></use>
            </svg> <!---->
           </div> <!---->
          </div> <!---->
         </div> <!---->
        </div>
       </div>
      </div>
     </div> <!----> 
     <div class="tm-page-width"></div> 
     <main class="tm-layout__container">
      <div hl="ru" data-async-called="true" class="tm-page">
       <div class="tm-page-width">
        <!----> 
        <div class="tm-page__wrapper">
         <div class="tm-page__main tm-page__main_has-sidebar">
          <div class="pull-down">
           <div class="pull-down__header" style="height:0px;">
            <div class="pull-down__content" style="bottom:10px;">
             <svg height="24" width="24" class="tm-svg-img pull-down__arrow">
              <title>Обновить</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#pull-arrow"></use>
             </svg>
            </div>
           </div> 
           <div class="tm-article-presenter"> 
            <div class="tm-article-presenter__body">
             <div class="tm-misprint-area">
              <div class="tm-misprint-area__wrapper">
               <article class="tm-article-presenter__content tm-article-presenter__content_narrow">
                <div class="tm-article-presenter__header"> 
                 <div class="tm-article-snippet tm-article-presenter__snippet">
                  <div class="tm-article-snippet__meta-container">
                   <div class="tm-article-snippet__meta">
                    <span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/quasilyte/" title="quasilyte" class="tm-user-info__userpic">
                      <div class="tm-entity-image">
                       <img alt="" height="24" src="//habrastorage.org/r/w32/getpro/habr/avatars/230/760/4b9/2307604b97e0f800b5f18bdfeb053554.png" width="24" class="tm-entity-image__pic">
                      </div></a> <span class="tm-user-info__user"><a href="/ru/users/quasilyte/" class="tm-user-info__username"> quasilyte </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2022-03-11T14:53:06.000Z" title="2022-03-11, 17:53">вчера в 17:53</time></span>
                   </div> <!---->
                  </div> 
                  <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Используем SQLite в KPHP и PHP через FFI</span></h1> 
                  <div class="tm-article-snippet__hubs">
                   <span class="tm-article-snippet__hubs-item"><a href="/ru/hub/webdev/" class="tm-article-snippet__hubs-item-link"><span>Разработка веб-сайтов</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/open_source/" class="tm-article-snippet__hubs-item-link"><span>Open source</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/php/" class="tm-article-snippet__hubs-item-link"><span>PHP</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/programming/" class="tm-article-snippet__hubs-item-link"><span>Программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/sqlite/" class="tm-article-snippet__hubs-item-link"><span>SQLite</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span>
                  </div> <!----> <!----> <!---->
                 </div>
                </div> <!----> 
                <div data-gallery-root="" lang="ru" class="tm-article-body">
                 <div></div> 
                 <div id="post-content-body">
                  <div>
                   <div class="article-formatted-body article-formatted-body_version-1">
                    <div xmlns="http://www.w3.org/1999/xhtml">
                     <p><img src="https://habrastorage.org/r/w1560/webt/bo/nc/pi/boncpiokbph5gehyjnsqycl_78i.png" data-src="https://habrastorage.org/webt/bo/nc/pi/boncpiokbph5gehyjnsqycl_78i.png"></p>
                     <br> 
                     <p>Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.</p>
                     <br> 
                     <p>Создавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:</p>
                     <br> 
                     <ul> 
                      <li>Как упростить установку и сделать библиотеку кроссплатформенной?</li> 
                      <li>Как не допустить утечек ресурсов?</li> 
                      <li>Как сделать библиотеку совместимой с KPHP и PHP?</li> 
                      <li>Какова производительность FFI решений?</li> 
                     </ul>
                     <br> 
                     <p>Мы не только попробуем новую библиотеку в действии, но и выработаем ряд практик, которые при широком распространении могут улучшить ситуацию с FFI пакетами в сообществе.</p><a name="habracut"></a>
                     <br> 
                     <h2 id="predislovie">Предисловие</h2>
                     <br> 
                     <p>Foreign Function Interface для PHP не так популярен, как мог бы быть, ведь для очень большого количества популярных библиотек уже есть нативные PHP расширения. Большинству будет достаточно чего-то из поставляемого с PHP, а для остальных есть внешние репозитории и <a href="https://pecl.php.net/" rel="nofollow noopener noreferrer">PECL</a>.</p>
                     <br> 
                     <p>У FFI есть ряд преимуществ:</p>
                     <br> 
                     <ul> 
                      <li>Не нужно писать сишный код</li> 
                      <li>После изменения кода библиотеки не требуется перекомпиляция модуля</li> 
                      <li>Более высокая обратная совместимость: мы не зависим от внутреннего Zend API</li> 
                      <li>Проще распространять код как composer пакеты</li> 
                      <li>Следуя конвенциям, мы можем сделать FFI пакеты ещё более удобными</li> 
                      <li>Потенциально более низкий порог входя для создания библиотек (но есть нюансы)</li> 
                     </ul>
                     <br> 
                     <p>Для KPHP этот инструмент стал единственным способом расширения со стороны. Причём работать такие расширения будут как на KPHP, так и на PHP.</p>
                     <br> 
                     <p>Есть так же и недостатки, связанные с этим подходом. Начиная от более низкой производительности, заканчивая менее обширной документацией. Хотя я бы сказал, что сам по себе FFI довольно прост. Сложности в основном возникают при попытках использовать FFI библиотеки в реальных условиях, а не в упрощённых CLI утилитах.</p>
                     <br> 
                     <p>Сегодня я постараюсь заполнить некоторые пробелы и поделиться некоторыми идеями по поводу того, как стоит проектировать и распространять FFI пакеты. Но начнём мы с обзора самой библиотеки KSQLite.</p>
                     <br> 
                     <h2 id="ustanovka-biblioteki">Установка библиотеки</h2>
                     <br> 
                     <p>Когда мы ставим обычный composer пакет, нам достаточно выполнить одну лишь команду <code>composer require</code>, и библиотека становится доступной в нашем проекте.</p>
                     <br> 
                     <p>Начнём как раз с этого:</p>
                     <br> 
                     <pre><code class="bash">$ composer require quasilyte/ksqlite</code></pre>
                     <br> 
                     <p>В случае с FFI библиотеками этого недостаточно. Кроме самой обёртки над C функциями нам так же нужна сама динамическая библиотека.</p>
                     <br> 
                     <p>Чтобы использовать KSQLite, нам потребуется <code>libsqlite3.so</code> на Линуксе, <code>libsqlite3.dylib</code> на MacOS и <code>libsqlite3.dll</code> на Windows.</p>
                     <br> 
                     <p>Допустим, мы устанавливаем библиотеку на Ubuntu.</p>
                     <br> 
                     <pre><code class="bash">$ sudo apt install sqlite3</code></pre>
                     <br> 
                     <p>Теперь нужно понять, где же находится <code>libsqlite3.so</code>.</p>
                     <br> 
                     <pre><code class="bash">$ ldconfig -p | grep sqlite3
  libsqlite3.so.0 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libsqlite3.so.0</code></pre>
                     <br> 
                     <p>Здесь мы уже встречаем первую сложность: вместо <code>libsqlite3.so</code> у нас файл называется <code>libsqlite3.so.0</code>. Сделав <code>dlopen("libsqlite3.so")</code> мы не сможем найти эту библиотеку.</p>
                     <br> 
                     <p>В PHP и KPHP имя динамической библиотеки указывается в заголовочном файле через <code>define FFI_LIB</code>.</p>
                     <br> 
                     <p>Для нашего случая мы могли бы в своей библиотеки написать что-то такое:</p>
                     <br> 
                     <pre><code class="plaintext">#define FFI_LIB "libsqlite3.so.0"</code></pre>
                     <br> 
                     <p>Этот заголовочный файл — часть библиотеки и composer пакета. Он один на все системы. Используя подход с указанием пути как на нашей машине, получаем следующие проблемы:</p>
                     <br> 
                     <ul> 
                      <li>А что, если у вас нет суффикса <code>.0</code> и файл доступен по обычному имени?</li> 
                      <li>Как быть с MacOS и Windows?</li> 
                      <li>Как понять, что загружена нужная версия библиотеки?</li> 
                     </ul>
                     <br> 
                     <p>Я предлагаю использовать следующую конвенцию во всех FFI пакетах:</p>
                     <br> 
                     <ol> 
                      <li>В <code>FFI_LIB</code> мы не указываем никакого расширения</li> 
                      <li>Пути пишем относительные, через директорию <code>ffilibs</code></li> 
                     </ol>
                     <br> 
                     <pre><code class="diff">- #define FFI_LIB "libsqlite3.so.0"
+ #define FFI_LIB "./ffilibs/libsqlite3"</code></pre>
                     <br> 
                     <p>Теперь для всех систем у нас есть одинаковый рецепт для установки: положить файлик динамической библиотеки в директорию <code>ffilibs</code> внутри корня приложения. Дополнительный уровень в виде <code>ffilibs</code> нужен для гибкости. Это может быть ссылка на системный каталог или на любое другое место, где мы сможем найти нужные библиотеки.</p>
                     <br> 
                     <h2 id="chto-mozhno-sozdat-s-pomoschyu-ksqlite">Что можно создать с помощью KSQLite</h2>
                     <br> 
                     <p>Никаких принципиальных ограничений нет. Всё то, что возможно с помощью расширения <a href="https://www.php.net/manual/ru/book.sqlite3.php" rel="nofollow noopener noreferrer">SQLite3</a>, можно сделать и через KSQLite.</p>
                     <br> 
                     <p>В примерах использования можно найти <a href="https://github.com/quasilyte/KSQLite/blob/master/examples/simple_site.php" rel="nofollow noopener noreferrer">simple_site</a>, который сохраняет данные в локальной базе SQLite.</p>
                     <br> 
                     <p><img src="https://habrastorage.org/r/w1560/webt/ys/m6/xe/ysm6xens23eqrhj0h7_53khn8ni.png" data-src="https://habrastorage.org/webt/ys/m6/xe/ysm6xens23eqrhj0h7_53khn8ni.png"></p>
                     <br> 
                     <p>Запустить этот пример можно на KPHP сервере, встроенном в PHP dev сервере и через любую другую связку (например, <code>nginx</code> с <code>php-fpm</code>). Вот пример запуска на встроенном сервере:</p>
                     <br> 
                     <pre><code class="bash"># Создадим ffilibs с ссылками на библиотеку, если их ещё нет.
mkdir -p ffilibs
ln -sf $(shell php -f locate_lib.php -- -q) ./ffilibs/libsqlite3

# Запускаем сервер.
$ php -d opcache.preload=preload.php -S localhost:8888</code></pre>
                     <br> 
                     <p>Скрипт <code>locate_lib.php</code> полезен как для пользователей, так и для CI окружений.</p>
                     <br> 
                     <pre><code class="bash"># Запуск без -q предназначен для людей, а не скриптов.
$ php -f locate_lib.php 
library candidate: /lib/x86_64-linux-gnu/libsqlite3.so.0
library candidate: /lib/x86_64-linux-gnu/libsqlite3.so

run something like this to make it discoverable (unix):
  mkdir -p ffilibs
  sudo ln -s /lib/x86_64-linux-gnu/libsqlite3.so ./ffilibs/libsqlite3</code></pre>
                     <br> 
                     <h2 id="pishem-zaprosy">Пишем запросы</h2>
                     <br> 
                     <p>Для начала нам нужно открыть соединение с базой данных:</p>
                     <br> 
                     <pre><code class="php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';

use KSQLite\KSQLite;

$db = new KSQLite();

// open() открывает существующий файл SQLite или создаёт
// новый в случае его отсутствия.
if (!$db-&gt;open('testdb')) {
  throw new Exception('open error: ' . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <p>Закрывать объект <code>$db</code> не нужно. Ниже мы ещё вернёмся к этому вопросу и разберёмся, как KSQLite управляет ресурсами и защищает пользователей от утечек памяти.</p>
                     <br> 
                     <p>KSQLite предоставляет три основных набора методов для исполнения запросов:</p>
                     <br> 
                     <ul> 
                      <li><code>exec</code> методы игнорируют возвращаемые базой данных результаты</li> 
                      <li><code>fetch</code> методы возвращают данные в виде массивов или скаляров</li> 
                      <li><code>query</code> методы позволяют самостоятельно обработать данные результатов</li> 
                     </ul>
                     <br> 
                     <p>Создадим тестовую таблицу. Для этого подойдёт метод <code>exec</code>:</p>
                     <br> 
                     <pre><code class="php">$query = '
  CREATE TABLE IF NOT EXISTS languages(
    lang_id INTEGER PRIMARY KEY,
    lang_name TEXT NOT NULL,
    first_appeared INTEGER NOT NULL,
    num_elephants REAL NOT NULL
  );
';
if (!$db-&gt;exec($query)) {
  // В настоящем коде у вас будет более серьёзная обработка ошибок.
  // Здесь же я буду просто швырять исключения.
  throw new Exception('create table error: ' . $db-&gt;getLastError()));
}</code></pre>
                     <br> 
                     <p>Добавим немного данных в таблицу <code>languages</code>. Будем вставлять по одной строке за запрос.</p>
                     <br> 
                     <pre><code class="php">$rows = [
  ['C', 1972, 0.0],
  ['C++', 1983, 0.0],
  ['JavaScript', 1995, 0.0],
  ['Go', 2009, 0.0],
];
foreach ($rows as $row) {
  $query = "
    INSERT INTO languages(lang_name, first_appeared, num_elephants)
    VALUES(?1, ?2, ?3)
  ";
  // Наш $row - это массив из 3 элементов, с индексами от 0 до 2.
  // Параметры запроса индексируются с 1.
  // Вспомогательная функция paramsFromList позволяет отобразить
  // массив привязок без ручной распаковки.
  //
  // Другими словами, массив ['C', 1972, 0.0] превращается в
  // [1 =&gt; 'C', 2 =&gt; 1972, 3 =&gt; 0.0].
  $params = KSQLite::paramsFromList($row);
  if (!$db-&gt;exec($query, $params)) {
    throw new Exception('insert: ' . $db-&gt;getLastError());
  }
}</code></pre>
                     <br> 
                     <p>Здесь для каждого <code>$row</code> мы заново парсим SQL запрос, выделяем statement объект и используем его для разовой вставки данных.</p>
                     <br> 
                     <p>Мы можем использовать prepared statement API для множественных операций над одним SQL statement:</p>
                     <br> 
                     <pre><code class="php">// Воспользуемся именованными параметрами привязок.
$rows = [
  [':name' =&gt; 'PHP', ':year' =&gt; 1995, ':elephants' =&gt; 1.0],
  [':name' =&gt; 'KPHP', ':year' =&gt; 2014, ':elephants' =&gt; 2.0],
];
$query = "
  INSERT INTO languages(lang_name, first_appeared, num_elephants)
  VALUES(?name, ?year, ?elephants)
";
$ok = $db-&gt;execPrepared($query, function(KSQLiteParamsBinder $b) use ($rows) {
  return $b-&gt;bindFromArray($rows);
});
if (!$db-&gt;exec($query, $params)) {
  throw new Exception('insert: ' . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <p><code>bindFromArray</code> — это вспомогательный метод для частого случая связывания данных по массиву. Без этого метода код выглядел бы как-то так:</p>
                     <br> 
                     <pre><code class="php">$ok = $db-&gt;execPrepared($query, function(KSQLiteParamsBinder $b) use ($rows) {
  if ($binder-&gt;query_index &gt;= count($rows)) {
    return false; // Больше у нас нет данных для вставки
  }
  foreach ($rows[$binder-&gt;query_index] as $k =&gt; $v) {
    $this-&gt;bind($k, $v);
  }
  return true; // Успешно связали параметры; запрос будет исполнен
});</code></pre>
                     <br> 
                     <p>Для массивов этот вариант выглядит переусложнённым, но он полезен, если генератор данных у нас похож на поток, где мы не знаем сколько раз нам нужно будет проводить вставку.</p>
                     <br> 
                     <p>Выборки данных проще всего делать через <code>fetch</code> методы.</p>
                     <br> 
                     <pre><code class="php">$query = 'SELECT COUNT(*) FROM languages';
[$count, $ok] = $db-&gt;fetchColumn($query);
if (!$ok) {
  throw new Exception('select count: ' . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <p><code>fetch</code>, как и остальные методы, поддерживает параметры запросов. Кроме этого, можно передать свою функцию-маппер и управлять тем, какие данные будут добавлены в выходной массив.</p>
                     <br> 
                     <pre><code class="php">$query = 'SELECT * FROM languages WHERE num_elephants &gt;= :x';
$params = [':x' =&gt; 1.0];
$mapper = function(KSQLiteQueryContext $ctx) {
  return $ctx-&gt;rowDataAssoc()['lang_name'];
};
[$lang_names, $ok] = $db-&gt;fetch($query, $params, $mapper);
if (!$ok) {
  throw new Exception('select langs: ' . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <h2 id="tranzakcii">Транзакции</h2>
                     <br> 
                     <p>Рассмотрим следующий пример:</p>
                     <br> 
                     <pre><code class="php">if (!$db-&gt;exec('BEGIN')) {
  throw new Exception('begin transaction: ' . $db-&gt;getLastError());
}
$ok = execute_queries($db); // Выполняем запросы внутри транзакции
$action = $ok ? 'COMMIT' : 'ROLLBACK';
if (!$db-&gt;exec($action)) {
  throw new Exception("$action :" . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <p>Этот подход будет работать в простейших случаях, но здесь очень легко допустить ошибку. Например, если <code>execute_queries()</code> может бросать исключение, то мы рискуем не выполнить <code>ROLLBACK</code>.</p>
                     <br> 
                     <p>Чтобы избежать таких ситуаций, нужно использовать ваши любимые паттерны для работы с транзакциями. Я покажу один из простых вариантов ниже.</p>
                     <br> 
                     <pre><code class="php">/**
 * @param KSQLite $db
 * @param callable(KSQLite):boolean
 */
function do_with_transaction(KSQLite $db, callable $fn): bool {
  if (!$db-&gt;exec('BEGIN')) {
    return false;
  }
  /** @var \Throwable $exception */
  $exception = null;
  try {
    $commit = $fn($db);
  } catch (\Throwable $e) {
    $db-&gt;exec('ROLLBACK');
    throw $e;
  }
  return $db-&gt;exec($commit ? 'COMMIT' : 'ROLLBACK');
}</code></pre>
                     <br> 
                     <p>С такой обёрткой код из примера выше превращается в это:</p>
                     <br> 
                     <pre><code class="php">$ok = do_with_transaction($db, function(KSQLite $db) {
  return execute_queries($db);
});
if (!$ok) {
  throw new Exception('do with transaction: ' . $db-&gt;getLastError());
}</code></pre>
                     <br> 
                     <h2 id="query-api">query API</h2>
                     <br> 
                     <p>Через <code>query</code> можно исполнить любой запрос: <code>fetch</code> и <code>exec</code> построены поверх <code>query</code>.</p>
                     <br> 
                     <p>Для демонстрации некоторых возможностей реализуем <code>fetch</code> используя <code>query</code>.</p>
                     <br> 
                     <p>В KPHP нельзя захватить переменную по ссылке, но захват объекта по значению эквивалентно ссылке. Поэтому, если из <code>query</code> нужно получить данные, делается это через заполнение объекта. Для некоторых случаев вам может хватить класса <code>KSQLiteArray</code>.</p>
                     <br> 
                     <pre><code class="php">// Я специально не использую type hints в сигнатуре
// чтобы определение функции было более компактным по ширине.

/**
 * @param KSQLite $db
 * @param string $sql
 * @param mixed[] $params query bind params
 * @param callable(KSQLiteQueryContext):mixed $f
 * @return tuple(mixed[],bool)
 */
function my_fetch($db, $sql, $params, $f) {
  $res = new KSQLiteArray();
  $row_func = function(KSQLiteQueryContext $ctx) use ($res, $f) {
    $res-&gt;values[] = $f($ctx);
  }
  $ok = $this-&gt;query($sql, $params, $row_func);
  return tuple($res-&gt;values, $ok);
}</code></pre>
                     <br> 
                     <ul> 
                      <li><code>$ctx-&gt;stop()</code> просит библиотеку пропустить все следующие result row sets</li> 
                      <li><code>$ctx-&gt;rowData()</code> читает данные в list-подобный массив (без строковых ключей)</li> 
                      <li><code>$ctx-&gt;rowDataAssoc()</code> подобен <code>rowData()</code> с ключами через <code>columnName()</code></li> 
                      <li><code>$ctx-&gt;columnName($i)</code> возвращает имя для i-го элемента данных</li> 
                      <li><code>$ctx-&gt;columnType($i)</code> возвращает тип для i-го элемента данных</li> 
                      <li><code>$ctx-&gt;numColumns()</code> возвращает количество столбцов в каждом result row set</li> 
                     </ul>
                     <br> 
                     <p>Можно обойти все результаты из выборки без чтения самих данных, если вам нужны только метаданные. До тех пор, пока не вызывается <code>rowData()</code> или <code>rowDataAssoc()</code>, KSQLite не пытается прочитать и разложить данные на PHP/KPHP массивы.</p>
                     <br> 
                     <h2 id="upravlenie-resursami-v-ksqlite">Управление ресурсами в KSQLite</h2>
                     <br> 
                     <p>Библиотека никогда не даёт пользователю объект, у которого есть методы <code>close()</code> или <code>finalize()</code>, за исключением самого объекта базы данных (но и тот по умолчанию не требует явного закрытия).</p>
                     <br> 
                     <p>Вместо этого методы для работы с данными принимают функции, контролирующие связку параметров запросов и итерацию по результатам. Таким образом, все создаваемые SQLite сущности, требующие очистки, не выходят за пределы публичного интерфейса KSQLite.</p>
                     <br> 
                     <p>Деструкторы могли бы быть альтернативой: финализация и/или <code>close()</code> вызывались бы "когда-то потом" и автоматически. Если при этом мы не даём публичных методов <code>close()</code>, то принципиальной разницы нет и очистка ресурсов всё ещё целиком лежит на самой библиотеке. Разве что с деструкторами становится менее очевидно, где заканчивается жизнь объекта. В контексте FFI и объектов, аллоцируемых C кодом, мы хотим быть вдвойне уверены, что память будет очищена правильно и своевременно. В наших интересах ограничивать время жизни таких объектов. Если мы предоставляем объекты с деструкторами, то пользователь может начать их сохранять в массивах, а, значит, мы рискуем очень долго не иметь возможности финализировать их.</p>
                     <br> 
                     <p>Если предоставлять публичные методы для финализации, то мы усложняем жизнь разработчикам. Использовать нашу библиотеку правильно становится сложнее. Если кто-то кинет исключение и не закроет ресурс перед этим, то ничем хорошим это не кончится.</p>
                     <br> 
                     <p>Я считаю, что для подобных FFI библиотек особо важно минимизировать прямое взаимодействие с "нативной" частью. Вместо того чтобы перекладывать ответственность за освобождение ресурсов на пользователя, можно скрыть сложность внутри и искоренить принципиальную возможность утечек памяти.</p>
                     <br> 
                     <p>Особенно сложно бороться с возможными <code>die()</code> или <code>exit()</code>. В идеале, стоит избегать этих механизмов, когда где-то рядом исполняется FFI код.</p>
                     <br> 
                     <h2 id="ochischaem-pamyat-dazhe-v-sluchae-dieexit">Очищаем память даже в случае die/exit</h2>
                     <br> 
                     <p>В KPHP нет деструкторов, поэтому единственное, что нас может спасти от внезапного прекращения работы скрипта — это функция, регистрируемая через <a href="https://www.php.net/manual/en/function.register-shutdown-function.php" rel="nofollow noopener noreferrer">register_shutdown_function</a>.</p>
                     <br> 
                     <p>Поскольку регистрировать на каждый объект, который мы хотим автоматически финализировать, новую shutdown функцию — это расточительно, рекомендуется использовать пакет <a href="https://github.com/quasilyte/KFinalize" rel="nofollow noopener noreferrer">KFinalize</a>. Этот пакет позволяет сохранить список финализаторов, которые будут запущены внутри одной shutdown функции.</p>
                     <br> 
                     <p>Именно через этот механизм и работает автоматический <code>close()</code> объектов <code>KSQLite</code>. При создании нового экземпляра, мы добавляем лямбду-финализатор в список <code>KFinalize</code>.</p>
                     <br> 
                     <p>Рассмотрим следующий пример кода:</p>
                     <br> 
                     <pre><code class="php">$query = 'SELECT 10 AS value';
$db-&gt;fetch($query, [], function(KSQLiteQueryContext $ctx) {
  if (some_cond()) {
    die("exiting right from the callback\n");
  }
  return 0;
});</code></pre>
                     <br> 
                     <p>Вся модель очистки ресурсов KSQLite построена на том, что объекты создаются и освобождаются вне вашего кода. Вот как исполняется <code>fetch</code> (упрощённо):</p>
                     <br> 
                     <ol> 
                      <li>Создаётся SQLite3 stmt</li> 
                      <li>Запускается SQLite3 step</li> 
                      <li>Вызывается предоставленная функция</li> 
                      <li>Когда данных больше нет, SQLite3 stmt очищается</li> 
                      <li>Из <code>fetch</code> возвращается результат</li> 
                     </ol>
                     <br> 
                     <p>Пользовательская функция вызывается в блоке try/catch, поэтому исключения не помешают корректной очистке ресурсов. Само исключение будет повторно запущено после очистки ресурсов запроса.</p>
                     <br> 
                     <p>Если же на шаге 3 произойдёт <code>exit()</code>, то мы никогда не перейдём к следующим шагам. Память, выделенная нативной библиотекой никогда не будет освобождена, потому что KPHP (и PHP) рантаймы ничего о ней не знают.</p>
                     <br> 
                     <p>Тем не менее выход есть. В классе KSQLite хранится список активных stmt объектов. Как только выделяется новый объект SQLite stmt, мы добавляем его в список. Затем мы исполняем алгоритм, как и раньше. Перед очищением памяти мы делаем <code>array_pop</code> из этого списка. В простейшем сценарии, этот список почти всегда содержит от 0 до 1 элементов.</p>
                     <br> 
                     <p>В нашем "деструкторе", который мы регистрируем для объекта KSQLite через KFinalize, мы обходим список активных объектов данного коннектора и финализируем их. Если никаких exit/die не было, то этот список будет пустым.</p>
                     <br> 
                     <p>Вот так выглядит деструктор для KSQLite:</p>
                     <br> 
                     <pre><code class="php">KFinalize::push(function() {
  foreach ($this-&gt;active_stmt_list as $stmt) {
    $this-&gt;lib-&gt;sqlite3_finalize($stmt);
  }
  // Вызывать close() безопасно даже если пользователь
  // вызывал его до этого вручную.
  $this-&gt;close();
});</code></pre>
                     <br> 
                     <h2 id="proizvoditelnost-ksqlite">Производительность KSQLite</h2>
                     <br> 
                     <p>Тесты производительности здесь нужны для того, чтобы понять, насколько FFI библиотеки могут сравниться по эффективности с нативными расширениями для PHP. FFI — это единственный на данный момент способ использовать C библиотеки из KPHP, поэтому логично включить в сравнение и этот пункт.</p>
                     <br> 
                     <p>Нагрузочное тестирование будем проводить следующим образом:</p>
                     <br> 
                     <ul> 
                      <li>В качестве работающего приложения возьмём <a href="https://github.com/quasilyte/KSQLite/blob/master/examples/simple_site.php" rel="nofollow noopener noreferrer">KSQLite/examples/simple_site</a>.</li> 
                      <li>Запускать PHP будем через <code>nginx</code> + <code>php-fpm</code></li> 
                      <li>Подавать нагрузку и измерять RPS будем через <code>ab</code></li> 
                      <li>Сервер и воркеры будут работать на выделенных ядрах</li> 
                      <li><code>ab</code> будет работать на других выделенных ядрах</li> 
                     </ul>
                     <br> 
                     <p>Подробнее о методике читайте под спойлерами ниже.</p>
                     <br> 
                     <div class="scrollable-table">
                      <table> 
                       <thead> 
                        <tr> 
                         <th>Test</th> 
                         <th>Requests/sec</th> 
                        </tr> 
                       </thead> 
                       <tbody> 
                        <tr> 
                         <td>PHP7.4 FFI</td> 
                         <td>5694</td> 
                        </tr> 
                        <tr> 
                         <td>PHP7.4 ext</td> 
                         <td>6415</td> 
                        </tr> 
                        <tr> 
                         <td>PHP8.1 FFI</td> 
                         <td>6147</td> 
                        </tr> 
                        <tr> 
                         <td>PHP8.1 ext</td> 
                         <td>6673</td> 
                        </tr> 
                        <tr> 
                         <td>KPHP FFI</td> 
                         <td>9010</td> 
                        </tr> 
                       </tbody> 
                      </table>
                     </div>
                     <br> 
                     <p>KSQLite на данный момент не содержит никаких оптимизаций для частных случаев. Даже простой <code>exec()</code>, которого в производимых бенчмарках много, выполняет лишнюю работу. В FFI вариантах мы получаем больше интерпретируемого PHP кода: часть логики <code>exec()</code> реализована на самом PHP, а не на C.</p>
                     <br> 
                     <p>Благодаря компиляции и информации о типах, вызовы из KPHP в C гораздо дешевле. Помогает и тот факт, что KPHP транслируется в C++, а из C++ легко можно вызывать C функции.</p>
                     <br> 
                     <ul> 
                      <li>PHP8.1 оказался быстрее PHP7.4 на <code>~5%</code> (JIT включен)</li> 
                      <li>KSQLite для PHP медленнее на <code>~10%</code></li> 
                      <li>KPHP с FFI в этом тесте на <code>~25%</code> быстрее чем, PHP8.1 ext</li> 
                     </ul>
                     <br> 
                     <div class="spoiler" role="button" tabindex="0"> <b class="spoiler_title">Дополнительная информация об окружении</b> 
                      <div class="spoiler_text">
                       <p>KPHP собран с коммита <code>1e584607616e237bc0abcc0e989e0a1725a08b68</code>.</p>
                       <br> 
                       <pre><code class="bash">$ php7.4 --version
PHP 7.4.3 (cli) (built: Nov 25 2021 23:16:22) ( NTS )

$ php8.1 --version
PHP 8.1.3 (cli) (built: Feb 21 2022 14:48:42) (NTS)

$ php8.1 -i | grep JIT
PCRE JIT Support =&gt; enabled
PCRE JIT Target =&gt; x86 64bit (little endian + unaligned)
JIT =&gt; On

$ sqlite3 --version
3.31.1 2020-01-27

$ nginx -v
nginx version: nginx/1.18.0 (Ubuntu)

$ ab -V
This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;

$ uname -a
Linux kphpbook 5.14.0-1024-oem 26-Ubuntu SMP Thu Feb 17 2022 x86_64 GNU/Linux</code></pre>
                       <br> 
                       <pre><code class="bash">$ lscpu
Architecture:       x86_64
CPU op-mode(s):     32-bit, 64-bit
Byte Order:         Little Endian
Address sizes:      39 bits physical, 48 bits virtual
CPU(s):             8
Thread(s) per core: 2
Core(s) per socket: 4
Socket(s):          1
NUMA node(s):       1
Vendor ID:          GenuineIntel
CPU family:         6
Model:              140
Model name:         11th Gen Intel(R) Core(TM) i7-1165G7 @ 2.80GHz
Stepping:           1
CPU MHz:            2800.000
CPU max MHz:        4700,0000
CPU min MHz:        400,0000
L1d cache:          192 KiB
L1i cache:          128 KiB
L2 cache:           5 MiB
L3 cache:           12 MiB</code></pre>
                      </div> 
                     </div>
                     <br> 
                     <div class="spoiler" role="button" tabindex="0"> <b class="spoiler_title">Как запускались бенчмарки</b> 
                      <div class="spoiler_text">
                       <p>Отключаем turbo boost (снижает RPS, но увеличивает точность измерений):</p>
                       <br> 
                       <pre><code class="bash">$ echo "1" | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo</code></pre>
                       <br> 
                       <p>Подготавливаем <code>nginx</code>:</p>
                       <br> 
                       <pre><code class="bash"># Сохраняем pid работающего мастер-процесса nginx:
$ nginx_pid=$(ps -aux | grep nginx | grep master | awk '{print $2}')
# Пытаемся закрепить nginx за ядрами 2, 3 и 4:
$ sudo taskset -cp 2-4 $nginx_pid
# Аналогично для всех worker-процессов:
$ nginx_workers=$(cat /proc/$nginx_pid/task/$nginx_pid/children)
$ for pid in $nginx_workers ; do sudo taskset -cp 2-4 $pid ; done</code></pre>
                       <br> 
                       <p>KPHP для тестов запускать так:</p>
                       <br> 
                       <pre><code class="bash"># У nginx на моей машине 8 воркеров, поэтому и в KPHP укажем это значение.
# Воркер-процессы, создаваемые веб-сервером, унаследуют параметры,
# выставляемые через taskset.
$ taskset -c 2-4 ./kphp_out/server --http-port 9000 --workers-num 8</code></pre>
                       <br> 
                       <p>А нагрузку подаём скриптом с ядер 5, 6 и 7:</p>
                       <br> 
                       <pre><code class="bash">$ taskset -c 5-7 \
    ab -T 'application/x-www-form-urlencoded' \
       -n 5000 \
       -c 4 \
       -p post.data \
       http://localhost:9001/</code></pre>
                      </div> 
                     </div>
                     <br> 
                     <h2 id="php-fpm--ffi-preloading">php-fpm + FFI preloading</h2>
                     <br> 
                     <p>Для того, чтобы PHP не разбирал заголовочные файлы на каждом запросе, рекомендуется использовать <code>FFI::scope</code>. Воспользоваться им можно только если нужные файлы были загружены на этапе opcache preload.</p>
                     <br> 
                     <p>Чтобы вся эта связка работала, надо подкрутить настройки нашего PHP.</p>
                     <br> 
                     <ol> 
                      <li><code>FFI::load</code> для регистрации в scope мы должны делать в preload контексте</li> 
                      <li>Мастер-процесс <code>php-fpm</code> должен быть запущен не от рута</li> 
                      <li>Нельзя использовать <code>opcache.preload_user</code></li> 
                     </ol>
                     <br> 
                     <p>Эти пункты взаимосвязаны. <code>opcache.preload</code> потребует указания <code>opcache.preload_user</code>, если <code>php-fpm</code> работает от рута. Если мы добавим в конфиг <code>opcache.preload_user</code>, у нас перестанет работать <code>FFI::load</code> внутри скрипта предзагрузки (на это неожиданное поведение даже заведён <a href="https://bugs.php.net/bug.php?id=79232&amp;edit=3" rel="nofollow noopener noreferrer">тикет</a>).</p>
                     <br> 
                     <p>Вариантов не очень много. <a href="https://www.reddit.com/r/PHP/comments/ezi8ne/official_ffipreload_example_is_broken/" rel="nofollow noopener noreferrer">В одном из обсуждений</a> на reddit можно найти подсказку к тому, как получить рабочее решение.</p>
                     <br> 
                     <p>Нам нужно выполнить пункт <code>(2)</code> и тогда все остальные будут выполнены без проблем, ведь <code>opcache.preload_user</code> требуется только для рута.</p>
                     <br> 
                     <p>Решение будет зависеть от системы.</p>
                     <br> 
                     <p>На моей Ubuntu нужно было отредактировать:</p>
                     <br> 
                     <ul> 
                      <li><code>/lib/systemd/system/php7.4-fpm.service</code></li> 
                      <li><code>/lib/systemd/system/php8.1-fpm.service</code></li> 
                     </ul>
                     <br> 
                     <p>В секцию <code>[Service]</code> добавляем <code>User</code> и <code>Group</code>:</p>
                     <br> 
                     <pre><code class="diff">[Service]
+ User=www-data
+ Group=www-data
  Type=notify</code></pre>
                     <br> 
                     <p>Далее можно попробовать перезапустить сервис <code>php-fpm</code>, но, скорее всего, нужно будет ещё поменять владельцев всех файлов и каталогов в корне сайта.<br> Условного <code>chown -R www-data ~/www</code> будет достаточно.</p>
                     <br> 
                     <p>Мне так же потребовалось поменять владельца файла логов <code>/var/log/php7.4-fpm.log</code>, но наверняка есть какой-то способ попросить <code>php-fpm</code> записывать логи в какое-то другое место, куда у пользователя будет более простой доступ.</p>
                     <br> 
                     <p>Теперь непосредственно к самому preload скрипту. Поскольку мы ожидаем, что все FFI библиотеки будут доступны по относительному пути, мы должны запускать <code>FFI::load</code> из нужной директории. В случае CLI рабочая директория будет предсказуемая, а вот <code>php-fpm</code> может запустить скрипт предзагрузки с самого корня (<code>/</code>). Чтобы сделать preload скрипт более независимым от рабочей директории, можно переходить в нужное место из самого скрипта.</p>
                     <br> 
                     <p>В проекте KSQLite файлы располагаются так:</p>
                     <br> 
                     <pre><code class="plaintext">examples/
  preload.php
  simple_site.php
ffilibs/
  libsqlite3
src/</code></pre>
                     <br> 
                     <p>Следовательно, <code>ffilibs</code> находится на уровень выше относительно <code>preload.php</code>.</p>
                     <br> 
                     <pre><code class="php">// Если бы preload.php находился в корне, здесь был бы просто __DIR__.
$root_path = __DIR__ . '/../';
if (!chdir($root_path)) {
  throw new Exception("failed chdir to $root_path\n");
}
// Запускаем тут все FFI::load от библиотек.
// Про договорённость Libname::loadFFI() читайте ниже.
load_ffi_libs(); </code></pre>
                     <br> 
                     <p>Теперь мы можем легко запускать приложение как через CLI, встроенный веб-сервер PHP (<code>-S</code>), <code>php-fpm</code>, а также в режиме собранного KPHP бинарника (тоже CLI + server).</p>
                     <br> 
                     <h2 id="testirovanie">Тестирование</h2>
                     <br> 
                     <p><img src="https://habrastorage.org/r/w1560/getpro/habr/post_images/452/ef7/ff0/452ef7ff04ba330c1277db05bc368715.png" data-src="https://habrastorage.org/getpro/habr/post_images/452/ef7/ff0/452ef7ff04ba330c1277db05bc368715.png"></p>
                     <br> 
                     <p>Тестировать мы будем как на PHP, так и на KPHP, поэтому нам понадобятся сразу два пакета:</p>
                     <br> 
                     <pre><code class="bash"># phpunit мы используем для запуска тестов в PHP режиме
$ composer require --dev phpunit/phpunit:9.5.16
# kphpunit - это то, что реализует phpunit для KPHP
$ composer require --dev vkcom/kphpunit:v1.0.0
# Устанавливаем утилиту ktest для запусков KPHP тестов и бенчмарков
$ composer require --dev vkcom/ktest-script</code></pre>
                     <br> 
                     <p>Исполнять тесты на обоих языках полезно, чтобы ловить некоторые нюансы различий поведения PHP и KPHP. А ещё это гарантирует, что типизация в проекте не сломалась.</p>
                     <br> 
                     <p>Создадим тестовый класс <code>tests/KSQLiteTest.php</code>:</p>
                     <br> 
                     <pre><code class="php">&lt;?php

use PHPUnit\Framework\TestCase;

class KSQLiteTest extends TestCase {
}</code></pre>
                     <br> 
                     <p>Заполнять <a href="https://github.com/quasilyte/KSQLite/blob/master/tests/KSQLiteTest.php" rel="nofollow noopener noreferrer">весь класс</a> в рамках этой статьи мы не будем. Затронем лишь самые важные аспекты.</p>
                     <br> 
                     <p>Для создания, заполнения и очистки БД мы воспользуемся <code>setUpBeforeClass</code> и <code>tearDownAfterClass</code>. Соединение с БД будем держать в статическом поле класса.</p>
                     <br> 
                     <div class="spoiler" role="button" tabindex="0"> <b class="spoiler_title">Упрощённый код setUpBeforeClass и tearDownAfterClass</b> 
                      <div class="spoiler_text">
                       <pre><code class="php">private static $db_filename = '';
private static KSQLite $db;
private static $coord_values = [];

public static function setUpBeforeClass(): void {
  if (KPHP_COMPILER_VERSION) { KSQLite::loadFFI(); }

  $tmp_dir = '/tmp'; // или sys_get_temp_dir()
  self::$db_filename = (string)tempnam($tmp_dir, 'testdb');

  self::$db = new KSQLite();
  if (!self::$db-&gt;open(self::$db_filename)) {
    throw new \Exception(self::$db-&gt;getLastError());
  }

  // Создаём тестовые таблицы.
  $tables = [
    'CREATE TABLE readonly_coord(
      coord_id INTEGER PRIMARY KEY,
      layer INTEGER DEFAULT 0 NOT NULL,
      x REAL NOT NULL,
      y REAL NOT NULL
    )',
  ];
  foreach ($tables as $q) {
    if (!self::$db-&gt;exec($q)) {
      throw new \Exception(self::$db-&gt;getLastError());
    }
  }

  $values = [
    [142.5, 218.0],
    [0.0, 0.0],
    [1.0, 1.0],
  ];
  // Значения нам понадобятся чтобы потом сравнивать
  // результаты выборок в тестах.
  foreach ($values as $i =&gt; $c) {
    [$x, $y] = $c;
    self::$coord_values[] = [
      'x' =&gt; $x,
      'y' =&gt; $y,
    ];
  }
  $q = 'INSERT INTO readonly_coord(x, y) VALUES(?, ?)';
  $bind_fn = function(KSQLiteParamsBinder $b) use ($values) {
    return $b-&gt;bindFromList($values);
  }
  $ok = self::$db-&gt;execPrepared($q, $bind_fn);
  if (!$ok) {
    throw new \Exception(self::$db-&gt;getLastError());
  }
}

public static function tearDownAfterClass(): void {
  self::$db-&gt;close();
  unlink(self::$db_filename);
}</code></pre>
                      </div> 
                     </div>
                     <br> 
                     <p>В написании самих тестов нет никаких особенностей. Обычные phpunit тесты.</p>
                     <br> 
                     <pre><code class="php">public function testFetchColumn() {
  $tests = [
    0,
    102,
    4.25,
    'str value',
    '"str value with quotes"',
    null,
  ];
  $query = 'SELECT :x';
  foreach ($tests as $x) {
    $params = [':x' =&gt; $x];
    [$col, $ok] = self::$db-&gt;fetchColumn($query, $params);
    $this-&gt;assertTrue($ok);
    $this-&gt;assertSame($col, $x);
  }

  $query = 'SELECT COUNT(*) FROM readonly_coord';
  [$count, $ok] = self::$db-&gt;fetchColumn($query);
  $this-&gt;assertTrue($ok);
  $this-&gt;assertSame($count, count(self::$coord_values));
}</code></pre>
                     <br> 
                     <p>Запуск phpunit для PHP:</p>
                     <br> 
                     <pre><code class="bash">$ php -d opcache.enable_cli=true \
      -d opcache.preload=preload.php \
      ./vendor/bin/phpunit \
      --bootstrap vendor/autoload.php tests</code></pre>
                     <br> 
                     <p>Запуск ktest (kphpunit) для KPHP:</p>
                     <br> 
                     <pre><code class="bash">$ ./vendor/bin/ktest phpunit --enable-ffi tests</code></pre>
                     <br> 
                     <p>На остальные вопросы по тестированию ответят исходники KSQLite:</p>
                     <br> 
                     <ul> 
                      <li><a href="https://github.com/quasilyte/KSQLite/blob/master/Makefile" rel="nofollow noopener noreferrer">Makefile</a> содержит команды <code>make test</code> и <code>make ci-test</code></li> 
                      <li><a href="https://github.com/quasilyte/KSQLite/blob/master/.github/workflows/php.yml" rel="nofollow noopener noreferrer">.github/workflows/php.yml</a> описывает workflow для запуска тестов</li> 
                      <li>Примеры (examples) можно превратить в тесты, см. <code>ktest compare</code></li> 
                     </ul>
                     <br> 
                     <blockquote>
                      Я рекомендую ознакомиться со статьёй <a href="https://habr.com/ru/company/vk/blog/572424/">Заметки KPHP: тестирование и бенчмарки</a>. Там тема тестирования KPHP затронута более полно.
                     </blockquote>
                     <br> 
                     <h2 id="benchmarki">Бенчмарки</h2>
                     <br> 
                     <p>Как уже упоминалось выше, KSQLite — это не многолетний код, который мог обрасти разнообразными оптимизациями. Многие функции можно ускорить.</p>
                     <br> 
                     <p>Но ускорять вслепую, руководствуясь только своей интуицией и предчувствием — это не самая эффективная методология. В худшем случае таким оптимизации могут сделать только хуже. Стоит производить хотя бы минимальные действия по проверке гипотезы — запускать бенчмарки.</p>
                     <br> 
                     <p>Создадим файл <code>benchmarks/BenchmarkKSQLite.php</code>:</p>
                     <br> 
                     <pre><code class="php">&lt;?php

use KSQLite\KSQLite;

class BenchmarkKSQLite {
  private KSQLite $db;

  public function __construct() {
    if (KPHP_COMPILER_VERSION) { KSQLite::loadFFI(); }
    $this-&gt;db = new KSQLite();
    if (!$this-&gt;db-&gt;open('benchdb')) {
      throw new \Exception($this-&gt;db-&gt;getLastError());
    }
  }

  public function benchmarkExecSelect1() {
    if (!$this-&gt;db-&gt;exec('SELECT 1')) {
      throw new \Exception($this-&gt;db-&gt;getLastError());
    }
  }

  public function benchmarkFetchRowConst() {
    [$_, $ok] = $this-&gt;db-&gt;fetchRow("SELECT 1, 2.5, 'hello', null");
    if (!$ok) {
      throw new \Exception($this-&gt;db-&gt;getLastError());
    }
  }
}</code></pre>
                     <br> 
                     <p>ktest позволяет запускать бенчмарки на PHP и KPHP. Это полезное свойство, ведь даже если приложение размещается на конечных серверах в виде KPHP бинарника, PHP часто используется для локального тестирования.</p>
                     <br> 
                     <pre><code class="bash"># Запускаем бенчмарки на KPHP:
$ ./vendor/bin/ktest bench ./benchmarks
BenchmarkKSQLite::ExecSelect1   14740   5520.0 ns/op
BenchmarkKSQLite::FetchCount    5340    16751.0 ns/op
BenchmarkKSQLite::FetchRowConst 7640    12406.0 ns/op
BenchmarkKSQLite::FetchOneRow   3380    29379.0 ns/op
BenchmarkKSQLite::FetchAllRows  3720    27008.0 ns/op
ok BenchmarkKSQLite

# Запускаем бенчмарки на PHP8.1:
$ ./vendor/bin/ktest bench-php --preload preload.php ./benchmarks
BenchmarkKSQLite::ExecSelect1   7760    12045.0 ns/op
BenchmarkKSQLite::FetchCount    2720    27958.0 ns/op
BenchmarkKSQLite::FetchRowConst 3860    23208.0 ns/op
BenchmarkKSQLite::FetchOneRow   2080    41163.0 ns/op
BenchmarkKSQLite::FetchAllRows  2400    40979.0 ns/op
ok BenchmarkKSQLite</code></pre>
                     <br> 
                     <p>Для удобного сравнения результатов бенчмарков PHP и KPHP есть команда <code>bench-vs-php</code>:</p>
                     <br> 
                     <pre><code class="bash">./vendor/bin/ktest bench-vs-php --preload preload.php ./benchmarks
name                    PHP time/op  KPHP time/op  delta
KSQLite::ExecSelect1    10.5µs ± 1%   5.5µs ± 3%  -47.95%
KSQLite::FetchCount     28.0µs ± 1%  17.1µs ± 1%  -38.79%
KSQLite::FetchRowConst  23.5µs ± 1%  11.5µs ± 1%  -50.82%
KSQLite::FetchOneRow    40.8µs ± 1%  27.1µs ± 1%  -33.57%
KSQLite::FetchAllRows   40.7µs ± 1%  26.5µs ± 1%  -35.07%</code></pre>
                     <br> 
                     <p>Подробнее о бенчмарках можно почитать в уже <a href="https://habr.com/ru/company/vk/blog/572424/">упомянутой выше статье</a>.</p>
                     <br> 
                     <h2 id="konvencii-dlya-ffi-paketov">Конвенции для FFI пакетов</h2>
                     <br> 
                     <p>В этой части кратко описаны основные концепции, вводимые в статье.</p>
                     <br> 
                     <div class="spoiler" role="button" tabindex="0"> <b class="spoiler_title">Опциональный текст</b> 
                      <div class="spoiler_text">
                       <h3 id="metod-loadffi">Метод loadFFI</h3>
                       <br> 
                       <p>Поскольку контексты загрузки могут отличаться для KPHP и PHP, стоит предоставить вызов инициализации в руки пользователей. В основном классе библиотеки определяем статический метод <code>loadFFI()</code>, который выполнит <code>FFI::load()</code> на все файлы, связанные с библиотекой.</p>
                       <br> 
                       <pre><code class="php">public static function loadFFI(): bool {
  return \FFI::load(__DIR__ . '/sqlite.h') !== null;
}</code></pre>
                       <br> 
                       <p>В KPHP вы будете вызывать этот метод где-то в начале скрипта, который является точкой входа в приложение:</p>
                       <br> 
                       <pre><code class="php">if (KPHP_COMPILER_VERSION) {
  KSQLite::loadFFI();
  SomeOtherLib::loadFFI();
}</code></pre>
                       <br> 
                       <p>В PHP это будет preload скрипт с такими же вызовами, но без проверки на KPHP_COMPILER_VERSION:</p>
                       <br> 
                       <pre><code class="php">&lt;?php

require_once __DIR__ . '/autoload.php'

KSQLite::loadFFI();
SomeOtherLib::loadFFI();</code></pre>
                       <br> 
                       <p>Почему это важно:</p>
                       <br> 
                       <ul> 
                        <li>Меньше беспорядка при использовании нескольких FFI библиотек</li> 
                        <li>Контроль над контекстом, в котором исполняется <code>FFI::load</code></li> 
                       </ul>
                       <br> 
                       <h3 id="opcachepreload-i-chdir">opcache.preload и chdir</h3>
                       <br> 
                       <p>В предыдущем примере мы использовали методы <code>loadFFI()</code>, но есть нюанс, который мы не затронули. В зависимости от приложения, <code>preload.php</code> может лежать в разных местах. Сам же скрипт тоже может запускаться из разных директорий.</p>
                       <br> 
                       <pre><code class="php">// Если бы preload.php находился в корне, здесь был бы просто __DIR__.
$root_path = __DIR__ . '/../';
if (!chdir($root_path)) {
  throw new Exception("failed chdir to $root_path\n");
}
KSQLite::loadFFI();
SomeOtherLib::loadFFI();</code></pre>
                       <br> 
                       <p>Почему это важно:</p>
                       <br> 
                       <ul> 
                        <li>Можно вызывать скрипт из любой директории</li> 
                        <li>Эта схема работает как для CLI, так и для <code>php-fpm</code></li> 
                       </ul>
                       <br> 
                       <h3 id="ffi_lib">FFI_LIB</h3>
                       <br> 
                       <p>Путь в <code>#define FFI_LIB</code> пишем относительный, через каталог <code>ffilibs</code>. Никакого платформенного расширения, типа <code>.so</code> мы не указываем.</p>
                       <br> 
                       <pre><code class="plaintext">#define FFI_LIB "./ffilibs/libsqlite3</code></pre>
                       <br> 
                       <p>Для удобства, рекомендуется предоставлять аналог скрипта <a href="https://github.com/quasilyte/KSQLite/blob/master/locate_lib.php" rel="nofollow noopener noreferrer">locate_lib.php</a>, чтобы пользователям было проще правильно установить библиотеку.</p>
                       <br> 
                       <p>Почему это важно:</p>
                       <br> 
                       <ul> 
                        <li>Проще инструкции установки. Везде идентичные (Windows, MacOS, Linux)</li> 
                        <li>Можно легко переносить директорию с проектом между машинами</li> 
                        <li><code>ffilibs</code> может быть ссылкой на какую-то системную папку </li> 
                       </ul>
                       <br> 
                       <h3 id="izbegaem-utechek-pamyati">Избегаем утечек памяти</h3>
                       <br> 
                       <p>Самостоятельно удалять объекты, созданные через <code>FFI::new</code> не нужно.</p>
                       <br> 
                       <p>Очистки или финализации требуют те объекты, что инициализируются внутри C кода. Эти аллокации могут либо менять внутреннее состояние библиотеки, либо использовать системный аллокатор. В любом из этих случаев, нам надо самостоятельно вызвать C функцию-деструктор, предоставляемую библиотекой.</p>
                       <br> 
                       <p>Вот несколько рекомендаций:</p>
                       <br> 
                       <ul> 
                        <li>Используйте <a href="https://github.com/quasilyte/KFinalize" rel="nofollow noopener noreferrer">KFinalize</a> для эмуляции деструкторов</li> 
                        <li>Если можно инкапсулировать финализируемые объекты — сделайте это</li> 
                        <li>Проектируйте такое API, которое сложно использовать неправильно</li> 
                       </ul>
                       <br> 
                       <p>Обработка ошибок должна быть консистентной и предсказуемой. Исключения могут быть неожиданными — пользователь должен быть к ним готов, чтобы на месте получения исключения освободить ресурсы.</p>
                       <br> 
                       <p>Почему это важно:</p>
                       <br> 
                       <ul> 
                        <li>В режиме работы сервера, небольшая утечка становится большой через пару тысяч запросов</li> 
                       </ul>
                      </div> 
                     </div>
                     <br> 
                     <h2 id="zaklyuchenie">Заключение</h2>
                     <br> 
                     <p>Попробуйте <a href="https://github.com/quasilyte/KSQLite" rel="nofollow noopener noreferrer">KSQLite</a> на PHP, а потом запустите его на KPHP.<br> Создавайте свои FFI библиотеки и <a href="https://github.com/quasilyte/awesome-kphp.git" rel="nofollow noopener noreferrer">делитесь ими</a>.</p>
                     <br> 
                     <p>Если у вас остались какие-то вопросы по KSQLite или FFI в KPHP — прошу в комментарии.</p>
                     <br> 
                     <h3 id="poleznye-ssylki">Полезные ссылки</h3>
                     <br> 
                     <ul> 
                      <li><a href="https://github.com/quasilyte/awesome-kphp.git" rel="nofollow noopener noreferrer">awesome-kphp</a></li> 
                      <li><a href="https://t.me/kphp_chat" rel="nofollow noopener noreferrer">Неофициальный чат KPHP-сообщества</a></li> 
                      <li>Статья <a href="https://habr.com/ru/company/vk/blog/581238/">Создаём игру на KPHP с помощью FFI и SDL</a></li> 
                      <li>Статья <a href="https://php.zone/post/kphp-in-life" rel="nofollow noopener noreferrer">Пробуем KPHP: реально ли его использовать в своих проектах</a></li> 
                      <li>Статья <a href="https://habr.com/ru/company/vk/blog/572424/">Заметки KPHP: тестирование и бенчмарки</a></li> 
                      <li>Статья <a href="https://habr.com/ru/company/vk/blog/527420/">ВКонтакте снова выкладывает KPHP</a></li> 
                     </ul>
                    </div>
                   </div>
                  </div> 
                  <div class="v-portal" style="display:none;"></div>
                 </div> <!----> <!---->
                </div> 
                <div class="tm-article-presenter__meta">
                 <div class="tm-separated-list tm-article-presenter__meta-list">
                  <span class="tm-separated-list__title">Теги:</span> 
                  <ul class="tm-separated-list__list">
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bkphp%5D" class="tm-tags-list__link">kphp</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bphp%5D" class="tm-tags-list__link">php</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bsqlite%5D" class="tm-tags-list__link">sqlite</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bffi%5D" class="tm-tags-list__link">ffi</a></li>
                   <li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bksqlite%5D" class="tm-tags-list__link">ksqlite</a></li>
                  </ul>
                 </div> 
                 <div class="tm-separated-list tm-article-presenter__meta-list">
                  <span class="tm-separated-list__title">Хабы:</span> 
                  <ul class="tm-separated-list__list">
                   <li class="tm-separated-list__item"><a href="/ru/hub/webdev/" class="tm-hubs-list__link"> Разработка веб-сайтов </a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/open_source/" class="tm-hubs-list__link"> Open source </a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/php/" class="tm-hubs-list__link"> PHP </a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/programming/" class="tm-hubs-list__link"> Программирование </a></li>
                   <li class="tm-separated-list__item"><a href="/ru/hub/sqlite/" class="tm-hubs-list__link"> SQLite </a></li>
                  </ul>
                 </div>
                </div>
               </article>
              </div> <!---->
             </div> 
             <div class="tm-article-sticky-panel">
              <div class="tm-data-icons tm-article-sticky-panel__icons">
               <div class="tm-article-rating tm-data-icons__item">
                <div class="tm-votes-meter tm-article-rating__votes-switcher">
                 <svg height="24" width="24" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_appearance-article">
                  <title>Всего голосов 12: ↑12 и ↓0</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-rating"></use>
                 </svg> <span title="Всего голосов 12: ↑12 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating">+12</span>
                </div> 
                <div class="v-portal" style="display:none;"></div>
               </div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item">
                <svg height="24" width="24" class="tm-svg-img tm-icon-counter__icon">
                 <title>Просмотры</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-views"></use>
                </svg> <span class="tm-icon-counter__value">669</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon">
                 <svg height="24" width="24" class="tm-svg-img tm-svg-icon">
                  <title>Добавить в закладки</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-favorite"></use>
                 </svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter"> 9 </span></button> <!----> 
               <div title="Поделиться" class="tm-sharing tm-data-icons__item">
                <button type="button" class="tm-sharing__button">
                 <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon">
                  <path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path>
                 </svg></button> 
                <div class="v-portal" style="display:none;"></div>
               </div> 
               <div class="v-portal" style="display:none;"></div>
              </div> 
             </div>
            </div> 
            <div class="v-portal" style="display:none;"></div> 
            <div class="tm-article-presenter__footer">
             <div class="tm-article-blocks">
              <!----> 
              <section class="tm-block tm-block_spacing-bottom">
               <!----> 
               <div class="tm-block__body tm-block__body_variant-balanced">
                <div class="tm-article-author"> 
                 <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article">
                  <div class="tm-user-card__info-container">
                   <div class="tm-user-card__header">
                    <div class="tm-user-card__header-data">
                     <a href="/ru/users/quasilyte/" class="tm-user-card__userpic tm-user-card__userpic_size-40">
                      <div class="tm-entity-image">
                       <img alt="" src="//habrastorage.org/getpro/habr/avatars/230/760/4b9/2307604b97e0f800b5f18bdfeb053554.png" class="tm-entity-image__pic">
                      </div></a> 
                     <div class="tm-user-card__meta">
                      <div title=" 124 голоса " class="tm-karma tm-user-card__karma">
                       <div class="tm-karma__votes tm-karma__votes_positive">
                         106 
                       </div> 
                       <div class="tm-karma__text">
                         Карма 
                       </div>
                      </div> 
                      <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating">
                       <div class="tm-rating__header"> 
                        <div class="tm-rating__counter">
                         32
                        </div>
                       </div> 
                       <div class="tm-rating__text">
                         Рейтинг 
                       </div>
                      </div>
                     </div>
                    </div>
                   </div> 
                   <div class="tm-user-card__info tm-user-card__info_variant-article">
                    <div class="tm-user-card__title tm-user-card__title_variant-article">
                     <span class="tm-user-card__name tm-user-card__name_variant-article">Искандер</span> <a href="/ru/users/quasilyte/" class="tm-user-card__nickname tm-user-card__nickname_variant-article"> @quasilyte </a> <!---->
                    </div> 
                    <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Making developer tools</p>
                   </div>
                  </div> 
                  <div class="tm-user-card__buttons tm-user-card__buttons_variant-article">
                   <!----> <!----> <!----> <!----> <!---->
                  </div>
                 </div> <!---->
                </div> 
                <div class="v-portal" style="display:none;"></div>
               </div> <!---->
              </section> 
              <div class="tm-ad-banner__container tm-page-article__banner">
               <!----> 
               <div id="articleBottomBanner5942" class="tm-ad-banner tm-ad-banner_variant-leaderboard"></div>
              </div> 
              <div class="tm-article-blocks__comments">
               <div class="tm-article-page-comments">
                <div class="tm-article-comments-counter-link tm-article-comments-counter-button">
                 <a href="/ru/post/653677/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style">
                  <svg height="24" width="24" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted">
                   <title>Комментарии</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-comments"></use>
                  </svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментарии 1 </span></a> <!---->
                </div>
               </div>
              </div> <!----> <!----> <!----> <!----> 
             </div>
            </div>
           </div>
          </div>
         </div> 
         <div class="tm-page__sidebar">
          <div class="tm-layout-sidebar">
           <div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial">
            <div class="tm-ad-banner__container tm-layout-sidebar__banner tm-layout-sidebar__banner_top">
             <!----> 
             <div id="sidebarBanner5943" class="tm-ad-banner tm-ad-banner_variant-half-page"></div>
            </div>
           </div> 
           <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;">
            <!----> 
            <section data-async-called="true" class="tm-block tm-block_spacing-bottom">
             <header class="tm-block__header">
              <h2 class="tm-block__title">Работа</h2> <!---->
             </header> 
             <div class="tm-block__body">
              <div class="tm-vacancies-block__item">
               <a href="https://career.habr.com/vacancies/php_programmist" target="_blank" class="tm-vacancies-block__vacancy-title"> PHP программист </a> 
               <div class="tm-vacancies-block__vacancies-count">
                 216 вакансий 
               </div>
              </div>
              <div class="tm-vacancies-block__item">
               <a href="https://career.habr.com/vacancies/programmist_laravel" target="_blank" class="tm-vacancies-block__vacancy-title"> Разработчик Laravel </a> 
               <div class="tm-vacancies-block__vacancies-count">
                 79 вакансий 
               </div>
              </div>
             </div> 
             <footer class="tm-block__footer">
              <a href="https://career.habr.com/catalog" class="tm-block-extralink"> Все вакансии </a>
             </footer>
            </section> 
            <div class="tm-ad-banner__container tm-layout-sidebar__banner tm-layout-sidebar__banner_bottom">
             <!----> 
             <div id="sidebarBannerBottom5944" class="tm-ad-banner tm-ad-banner_variant-medium-rectangle"></div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </main> <!---->
    </div> 
    <div class="tm-footer-menu">
     <div class="tm-page-width">
      <div class="tm-footer-menu__container">
       <div class="tm-footer-menu__block">
        <h3 class="tm-footer-menu__block-title"> Ваш аккаунт </h3> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/653677/&amp;hl=ru" rel="nofollow" target="_self"> Войти </a></li>
          <li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/653677/&amp;hl=ru" rel="nofollow" target="_self"> Регистрация </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <h3 class="tm-footer-menu__block-title"> Разделы </h3> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active"> Публикации </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link"> Новости </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link"> Хабы </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link"> Компании </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link"> Авторы </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link"> Песочница </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <h3 class="tm-footer-menu__block-title"> Информация </h3> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link"> Устройство сайта </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link"> Для авторов </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link"> Для компаний </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link"> Документы </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank"> Соглашение </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank"> Конфиденциальность </a></li>
         </ul>
        </div>
       </div>
       <div class="tm-footer-menu__block">
        <h3 class="tm-footer-menu__block-title"> Услуги </h3> 
        <div class="tm-footer-menu__block-content">
         <ul class="tm-footer-menu__list">
          <li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank"> Реклама </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank"> Тарифы </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank"> Контент </a></li>
          <li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank"> Семинары </a></li>
          <li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link"> Мегапроекты </a></li>
         </ul>
        </div>
       </div>
      </div>
     </div>
    </div> 
    <div class="tm-footer">
     <div class="tm-page-width">
      <div class="tm-footer__container">
       <!----> 
       <div class="tm-footer__social">
        <a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use>
         </svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use>
         </svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use>
         </svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use>
         </svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use>
         </svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon">
         <svg height="16" width="16" class="tm-svg-img tm-svg-icon">
          <title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use>
         </svg></a>
       </div> 
       <div class="v-portal" style="display:none;"></div> <button class="tm-footer__link"><!----> Настройка языка </button> <a href="/ru/about" class="tm-footer__link"> О сайте </a> <a href="/ru/feedback/" class="tm-footer__link"> Техническая поддержка </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link"> Вернуться на старую версию </a> 
       <div class="tm-footer-copyright">
        <span class="tm-copyright"><span class="tm-copyright__years">© 2006–2022 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span>
       </div>
      </div>
     </div>
    </div> <!----> <!---->
   </div> 
   <div class="vue-portal-target"></div>
  </div> 
  <script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"653677":{"id":"653677","timePublished":"2022-03-11T14:53:06+00:00","isCorporative":false,"lang":"ru","titleHtml":"Используем SQLite в KPHP и PHP через FFI","leadData":{"textHtml":"\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fbo\u002Fnc\u002Fpi\u002Fboncpiokbph5gehyjnsqycl_78i.png\"\u003E\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EСегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EСоздавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EКак упростить установку и сделать библиотеку кроссплатформенной?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак не допустить утечек ресурсов?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак сделать библиотеку совместимой с KPHP и PHP?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКакова производительность FFI решений?\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u003E\r\n\u003Cp\u003EМы не только попробуем новую библиотеку в действии, но и выработаем ряд практик, которые при широком распространении могут улучшить ситуацию с FFI пакетами в сообществе.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":106,"votesCount":124},"rating":32,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1093718","alias":"quasilyte","fullname":"Искандер","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F230\u002F760\u002F4b9\u002F2307604b97e0f800b5f18bdfeb053554.png","speciality":"Making developer tools"},"statistics":{"commentsCount":1,"favoritesCount":9,"readingCount":669,"score":12,"votesCount":12},"hubs":[{"relatedData":null,"id":"91","alias":"webdev","type":"collective","title":"Разработка веб-сайтов","titleHtml":"Разработка веб-сайтов","isProfiled":true},{"relatedData":null,"id":"144","alias":"open_source","type":"collective","title":"Open source","titleHtml":"Open source","isProfiled":true},{"relatedData":null,"id":"260","alias":"php","type":"collective","title":"PHP","titleHtml":"PHP","isProfiled":true},{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"18554","alias":"sqlite","type":"collective","title":"SQLite","titleHtml":"SQLite","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fbo\u002Fnc\u002Fpi\u002Fboncpiokbph5gehyjnsqycl_78i.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fbo\u002Fnc\u002Fpi\u002Fboncpiokbph5gehyjnsqycl_78i.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EКак упростить установку и сделать библиотеку кроссплатформенной?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак не допустить утечек ресурсов?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак сделать библиотеку совместимой с KPHP и PHP?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКакова производительность FFI решений?\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМы не только попробуем новую библиотеку в действии, но и выработаем ряд практик, которые при широком распространении могут улучшить ситуацию с FFI пакетами в сообществе.\u003C\u002Fp\u003E\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"predislovie\"\u003EПредисловие\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EForeign Function Interface для PHP не так популярен, как мог бы быть, ведь для очень большого количества популярных библиотек уже есть нативные PHP расширения. Большинству будет достаточно чего-то из поставляемого с PHP, а для остальных есть внешние репозитории и \u003Ca href=\"https:\u002F\u002Fpecl.php.net\u002F\" rel=\"nofollow noopener noreferrer\"\u003EPECL\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EУ FFI есть ряд преимуществ:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EНе нужно писать сишный код\u003C\u002Fli\u003E\r\n\u003Cli\u003EПосле изменения кода библиотеки не требуется перекомпиляция модуля\u003C\u002Fli\u003E\r\n\u003Cli\u003EБолее высокая обратная совместимость: мы не зависим от внутреннего Zend API\u003C\u002Fli\u003E\r\n\u003Cli\u003EПроще распространять код как composer пакеты\u003C\u002Fli\u003E\r\n\u003Cli\u003EСледуя конвенциям, мы можем сделать FFI пакеты ещё более удобными\u003C\u002Fli\u003E\r\n\u003Cli\u003EПотенциально более низкий порог входя для создания библиотек (но есть нюансы)\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля KPHP этот инструмент стал единственным способом расширения со стороны. Причём работать такие расширения будут как на KPHP, так и на PHP.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЕсть так же и недостатки, связанные с этим подходом. Начиная от более низкой производительности, заканчивая менее обширной документацией. Хотя я бы сказал, что сам по себе FFI довольно прост. Сложности в основном возникают при попытках использовать FFI библиотеки в реальных условиях, а не в упрощённых CLI утилитах.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСегодня я постараюсь заполнить некоторые пробелы и поделиться некоторыми идеями по поводу того, как стоит проектировать и распространять FFI пакеты. Но начнём мы с обзора самой библиотеки KSQLite.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"ustanovka-biblioteki\"\u003EУстановка библиотеки\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКогда мы ставим обычный composer пакет, нам достаточно выполнить одну лишь команду \u003Ccode\u003Ecomposer require\u003C\u002Fcode\u003E, и библиотека становится доступной в нашем проекте.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНачнём как раз с этого:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ composer require quasilyte\u002Fksqlite\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ случае с FFI библиотеками этого недостаточно. Кроме самой обёртки над C функциями нам так же нужна сама динамическая библиотека.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы использовать KSQLite, нам потребуется \u003Ccode\u003Elibsqlite3.so\u003C\u002Fcode\u003E на Линуксе, \u003Ccode\u003Elibsqlite3.dylib\u003C\u002Fcode\u003E на MacOS и \u003Ccode\u003Elibsqlite3.dll\u003C\u002Fcode\u003E на Windows.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДопустим, мы устанавливаем библиотеку на Ubuntu.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ sudo apt install sqlite3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь нужно понять, где же находится \u003Ccode\u003Elibsqlite3.so\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ ldconfig -p | grep sqlite3\n  libsqlite3.so.0 (libc6,x86-64) =\u003E \u002Flib\u002Fx86_64-linux-gnu\u002Flibsqlite3.so.0\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗдесь мы уже встречаем первую сложность: вместо \u003Ccode\u003Elibsqlite3.so\u003C\u002Fcode\u003E у нас файл называется \u003Ccode\u003Elibsqlite3.so.0\u003C\u002Fcode\u003E. Сделав \u003Ccode\u003Edlopen(\"libsqlite3.so\")\u003C\u002Fcode\u003E мы не сможем найти эту библиотеку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ PHP и KPHP имя динамической библиотеки указывается в заголовочном файле через \u003Ccode\u003Edefine FFI_LIB\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля нашего случая мы могли бы в своей библиотеки написать что-то такое:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E#define FFI_LIB \"libsqlite3.so.0\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭтот заголовочный файл — часть библиотеки и composer пакета. Он один на все системы. Используя подход с указанием пути как на нашей машине, получаем следующие проблемы:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EА что, если у вас нет суффикса \u003Ccode\u003E.0\u003C\u002Fcode\u003E и файл доступен по обычному имени?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак быть с MacOS и Windows?\u003C\u002Fli\u003E\r\n\u003Cli\u003EКак понять, что загружена нужная версия библиотеки?\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ предлагаю использовать следующую конвенцию во всех FFI пакетах:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EВ \u003Ccode\u003EFFI_LIB\u003C\u002Fcode\u003E мы не указываем никакого расширения\u003C\u002Fli\u003E\r\n\u003Cli\u003EПути пишем относительные, через директорию \u003Ccode\u003Effilibs\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"diff\"\u003E- #define FFI_LIB \"libsqlite3.so.0\"\n+ #define FFI_LIB \".\u002Fffilibs\u002Flibsqlite3\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь для всех систем у нас есть одинаковый рецепт для установки: положить файлик динамической библиотеки в директорию \u003Ccode\u003Effilibs\u003C\u002Fcode\u003E внутри корня приложения. Дополнительный уровень в виде \u003Ccode\u003Effilibs\u003C\u002Fcode\u003E нужен для гибкости. Это может быть ссылка на системный каталог или на любое другое место, где мы сможем найти нужные библиотеки.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"chto-mozhno-sozdat-s-pomoschyu-ksqlite\"\u003EЧто можно создать с помощью KSQLite\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНикаких принципиальных ограничений нет. Всё то, что возможно с помощью расширения \u003Ca href=\"https:\u002F\u002Fwww.php.net\u002Fmanual\u002Fru\u002Fbook.sqlite3.php\" rel=\"nofollow noopener noreferrer\"\u003ESQLite3\u003C\u002Fa\u003E, можно сделать и через KSQLite.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ примерах использования можно найти \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002Fexamples\u002Fsimple_site.php\" rel=\"nofollow noopener noreferrer\"\u003Esimple_site\u003C\u002Fa\u003E, который сохраняет данные в локальной базе SQLite.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fys\u002Fm6\u002Fxe\u002Fysm6xens23eqrhj0h7_53khn8ni.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fys\u002Fm6\u002Fxe\u002Fysm6xens23eqrhj0h7_53khn8ni.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗапустить этот пример можно на KPHP сервере, встроенном в PHP dev сервере и через любую другую связку (например, \u003Ccode\u003Enginx\u003C\u002Fcode\u003E с \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E). Вот пример запуска на встроенном сервере:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# Создадим ffilibs с ссылками на библиотеку, если их ещё нет.\nmkdir -p ffilibs\nln -sf $(shell php -f locate_lib.php -- -q) .\u002Fffilibs\u002Flibsqlite3\n\n# Запускаем сервер.\n$ php -d opcache.preload=preload.php -S localhost:8888\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСкрипт \u003Ccode\u003Elocate_lib.php\u003C\u002Fcode\u003E полезен как для пользователей, так и для CI окружений.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# Запуск без -q предназначен для людей, а не скриптов.\n$ php -f locate_lib.php \nlibrary candidate: \u002Flib\u002Fx86_64-linux-gnu\u002Flibsqlite3.so.0\nlibrary candidate: \u002Flib\u002Fx86_64-linux-gnu\u002Flibsqlite3.so\n\nrun something like this to make it discoverable (unix):\n  mkdir -p ffilibs\n  sudo ln -s \u002Flib\u002Fx86_64-linux-gnu\u002Flibsqlite3.so .\u002Fffilibs\u002Flibsqlite3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"pishem-zaprosy\"\u003EПишем запросы\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля начала нам нужно открыть соединение с базой данных:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E&lt;?php\n\nrequire_once __DIR__ . '\u002Fvendor\u002Fautoload.php';\n\nuse KSQLite\\KSQLite;\n\n$db = new KSQLite();\n\n\u002F\u002F open() открывает существующий файл SQLite или создаёт\n\u002F\u002F новый в случае его отсутствия.\nif (!$db-\u003Eopen('testdb')) {\n  throw new Exception('open error: ' . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗакрывать объект \u003Ccode\u003E$db\u003C\u002Fcode\u003E не нужно. Ниже мы ещё вернёмся к этому вопросу и разберёмся, как KSQLite управляет ресурсами и защищает пользователей от утечек памяти.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EKSQLite предоставляет три основных набора методов для исполнения запросов:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ccode\u003Eexec\u003C\u002Fcode\u003E методы игнорируют возвращаемые базой данных результаты\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003Efetch\u003C\u002Fcode\u003E методы возвращают данные в виде массивов или скаляров\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003Equery\u003C\u002Fcode\u003E методы позволяют самостоятельно обработать данные результатов\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим тестовую таблицу. Для этого подойдёт метод \u003Ccode\u003Eexec\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$query = '\n  CREATE TABLE IF NOT EXISTS languages(\n    lang_id INTEGER PRIMARY KEY,\n    lang_name TEXT NOT NULL,\n    first_appeared INTEGER NOT NULL,\n    num_elephants REAL NOT NULL\n  );\n';\nif (!$db-\u003Eexec($query)) {\n  \u002F\u002F В настоящем коде у вас будет более серьёзная обработка ошибок.\n  \u002F\u002F Здесь же я буду просто швырять исключения.\n  throw new Exception('create table error: ' . $db-\u003EgetLastError()));\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДобавим немного данных в таблицу \u003Ccode\u003Elanguages\u003C\u002Fcode\u003E. Будем вставлять по одной строке за запрос.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$rows = [\n  ['C', 1972, 0.0],\n  ['C++', 1983, 0.0],\n  ['JavaScript', 1995, 0.0],\n  ['Go', 2009, 0.0],\n];\nforeach ($rows as $row) {\n  $query = \"\n    INSERT INTO languages(lang_name, first_appeared, num_elephants)\n    VALUES(?1, ?2, ?3)\n  \";\n  \u002F\u002F Наш $row - это массив из 3 элементов, с индексами от 0 до 2.\n  \u002F\u002F Параметры запроса индексируются с 1.\n  \u002F\u002F Вспомогательная функция paramsFromList позволяет отобразить\n  \u002F\u002F массив привязок без ручной распаковки.\n  \u002F\u002F\n  \u002F\u002F Другими словами, массив ['C', 1972, 0.0] превращается в\n  \u002F\u002F [1 =\u003E 'C', 2 =\u003E 1972, 3 =\u003E 0.0].\n  $params = KSQLite::paramsFromList($row);\n  if (!$db-\u003Eexec($query, $params)) {\n    throw new Exception('insert: ' . $db-\u003EgetLastError());\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗдесь для каждого \u003Ccode\u003E$row\u003C\u002Fcode\u003E мы заново парсим SQL запрос, выделяем statement объект и используем его для разовой вставки данных.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМы можем использовать prepared statement API для множественных операций над одним SQL statement:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E\u002F\u002F Воспользуемся именованными параметрами привязок.\n$rows = [\n  [':name' =\u003E 'PHP', ':year' =\u003E 1995, ':elephants' =\u003E 1.0],\n  [':name' =\u003E 'KPHP', ':year' =\u003E 2014, ':elephants' =\u003E 2.0],\n];\n$query = \"\n  INSERT INTO languages(lang_name, first_appeared, num_elephants)\n  VALUES(?name, ?year, ?elephants)\n\";\n$ok = $db-\u003EexecPrepared($query, function(KSQLiteParamsBinder $b) use ($rows) {\n  return $b-\u003EbindFromArray($rows);\n});\nif (!$db-\u003Eexec($query, $params)) {\n  throw new Exception('insert: ' . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ccode\u003EbindFromArray\u003C\u002Fcode\u003E — это вспомогательный метод для частого случая связывания данных по массиву. Без этого метода код выглядел бы как-то так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$ok = $db-\u003EexecPrepared($query, function(KSQLiteParamsBinder $b) use ($rows) {\n  if ($binder-\u003Equery_index \u003E= count($rows)) {\n    return false; \u002F\u002F Больше у нас нет данных для вставки\n  }\n  foreach ($rows[$binder-\u003Equery_index] as $k =\u003E $v) {\n    $this-\u003Ebind($k, $v);\n  }\n  return true; \u002F\u002F Успешно связали параметры; запрос будет исполнен\n});\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля массивов этот вариант выглядит переусложнённым, но он полезен, если генератор данных у нас похож на поток, где мы не знаем сколько раз нам нужно будет проводить вставку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВыборки данных проще всего делать через \u003Ccode\u003Efetch\u003C\u002Fcode\u003E методы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$query = 'SELECT COUNT(*) FROM languages';\n[$count, $ok] = $db-\u003EfetchColumn($query);\nif (!$ok) {\n  throw new Exception('select count: ' . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ccode\u003Efetch\u003C\u002Fcode\u003E, как и остальные методы, поддерживает параметры запросов. Кроме этого, можно передать свою функцию-маппер и управлять тем, какие данные будут добавлены в выходной массив.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$query = 'SELECT * FROM languages WHERE num_elephants \u003E= :x';\n$params = [':x' =\u003E 1.0];\n$mapper = function(KSQLiteQueryContext $ctx) {\n  return $ctx-\u003ErowDataAssoc()['lang_name'];\n};\n[$lang_names, $ok] = $db-\u003Efetch($query, $params, $mapper);\nif (!$ok) {\n  throw new Exception('select langs: ' . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"tranzakcii\"\u003EТранзакции\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРассмотрим следующий пример:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003Eif (!$db-\u003Eexec('BEGIN')) {\n  throw new Exception('begin transaction: ' . $db-\u003EgetLastError());\n}\n$ok = execute_queries($db); \u002F\u002F Выполняем запросы внутри транзакции\n$action = $ok ? 'COMMIT' : 'ROLLBACK';\nif (!$db-\u003Eexec($action)) {\n  throw new Exception(\"$action :\" . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭтот подход будет работать в простейших случаях, но здесь очень легко допустить ошибку. Например, если \u003Ccode\u003Eexecute_queries()\u003C\u002Fcode\u003E может бросать исключение, то мы рискуем не выполнить \u003Ccode\u003EROLLBACK\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы избежать таких ситуаций, нужно использовать ваши любимые паттерны для работы с транзакциями. Я покажу один из простых вариантов ниже.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E\u002F**\n * @param KSQLite $db\n * @param callable(KSQLite):boolean\n *\u002F\nfunction do_with_transaction(KSQLite $db, callable $fn): bool {\n  if (!$db-\u003Eexec('BEGIN')) {\n    return false;\n  }\n  \u002F** @var \\Throwable $exception *\u002F\n  $exception = null;\n  try {\n    $commit = $fn($db);\n  } catch (\\Throwable $e) {\n    $db-\u003Eexec('ROLLBACK');\n    throw $e;\n  }\n  return $db-\u003Eexec($commit ? 'COMMIT' : 'ROLLBACK');\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EС такой обёрткой код из примера выше превращается в это:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$ok = do_with_transaction($db, function(KSQLite $db) {\n  return execute_queries($db);\n});\nif (!$ok) {\n  throw new Exception('do with transaction: ' . $db-\u003EgetLastError());\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"query-api\"\u003Equery API\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧерез \u003Ccode\u003Equery\u003C\u002Fcode\u003E можно исполнить любой запрос: \u003Ccode\u003Efetch\u003C\u002Fcode\u003E и \u003Ccode\u003Eexec\u003C\u002Fcode\u003E построены поверх \u003Ccode\u003Equery\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля демонстрации некоторых возможностей реализуем \u003Ccode\u003Efetch\u003C\u002Fcode\u003E используя \u003Ccode\u003Equery\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ KPHP нельзя захватить переменную по ссылке, но захват объекта по значению эквивалентно ссылке. Поэтому, если из \u003Ccode\u003Equery\u003C\u002Fcode\u003E нужно получить данные, делается это через заполнение объекта. Для некоторых случаев вам может хватить класса \u003Ccode\u003EKSQLiteArray\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E\u002F\u002F Я специально не использую type hints в сигнатуре\n\u002F\u002F чтобы определение функции было более компактным по ширине.\n\n\u002F**\n * @param KSQLite $db\n * @param string $sql\n * @param mixed[] $params query bind params\n * @param callable(KSQLiteQueryContext):mixed $f\n * @return tuple(mixed[],bool)\n *\u002F\nfunction my_fetch($db, $sql, $params, $f) {\n  $res = new KSQLiteArray();\n  $row_func = function(KSQLiteQueryContext $ctx) use ($res, $f) {\n    $res-\u003Evalues[] = $f($ctx);\n  }\n  $ok = $this-\u003Equery($sql, $params, $row_func);\n  return tuple($res-\u003Evalues, $ok);\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003Estop()\u003C\u002Fcode\u003E просит библиотеку пропустить все следующие result row sets\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003ErowData()\u003C\u002Fcode\u003E читает данные в list-подобный массив (без строковых ключей)\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003ErowDataAssoc()\u003C\u002Fcode\u003E подобен \u003Ccode\u003ErowData()\u003C\u002Fcode\u003E с ключами через \u003Ccode\u003EcolumnName()\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003EcolumnName($i)\u003C\u002Fcode\u003E возвращает имя для i-го элемента данных\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003EcolumnType($i)\u003C\u002Fcode\u003E возвращает тип для i-го элемента данных\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E$ctx-\u003EnumColumns()\u003C\u002Fcode\u003E возвращает количество столбцов в каждом result row set\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМожно обойти все результаты из выборки без чтения самих данных, если вам нужны только метаданные. До тех пор, пока не вызывается \u003Ccode\u003ErowData()\u003C\u002Fcode\u003E или \u003Ccode\u003ErowDataAssoc()\u003C\u002Fcode\u003E, KSQLite не пытается прочитать и разложить данные на PHP\u002FKPHP массивы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"upravlenie-resursami-v-ksqlite\"\u003EУправление ресурсами в KSQLite\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EБиблиотека никогда не даёт пользователю объект, у которого есть методы \u003Ccode\u003Eclose()\u003C\u002Fcode\u003E или \u003Ccode\u003Efinalize()\u003C\u002Fcode\u003E, за исключением самого объекта базы данных (но и тот по умолчанию не требует явного закрытия).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВместо этого методы для работы с данными принимают функции, контролирующие связку параметров запросов и итерацию по результатам. Таким образом, все создаваемые SQLite сущности, требующие очистки, не выходят за пределы публичного интерфейса KSQLite.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДеструкторы могли бы быть альтернативой: финализация и\u002Fили \u003Ccode\u003Eclose()\u003C\u002Fcode\u003E вызывались бы \"когда-то потом\" и автоматически. Если при этом мы не даём публичных методов \u003Ccode\u003Eclose()\u003C\u002Fcode\u003E, то принципиальной разницы нет и очистка ресурсов всё ещё целиком лежит на самой библиотеке. Разве что с деструкторами становится менее очевидно, где заканчивается жизнь объекта. В контексте FFI и объектов, аллоцируемых C кодом, мы хотим быть вдвойне уверены, что память будет очищена правильно и своевременно. В наших интересах ограничивать время жизни таких объектов. Если мы предоставляем объекты с деструкторами, то пользователь может начать их сохранять в массивах, а, значит, мы рискуем очень долго не иметь возможности финализировать их.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЕсли предоставлять публичные методы для финализации, то мы усложняем жизнь разработчикам. Использовать нашу библиотеку правильно становится сложнее. Если кто-то кинет исключение и не закроет ресурс перед этим, то ничем хорошим это не кончится.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ считаю, что для подобных FFI библиотек особо важно минимизировать прямое взаимодействие с \"нативной\" частью. Вместо того чтобы перекладывать ответственность за освобождение ресурсов на пользователя, можно скрыть сложность внутри и искоренить принципиальную возможность утечек памяти.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОсобенно сложно бороться с возможными \u003Ccode\u003Edie()\u003C\u002Fcode\u003E или \u003Ccode\u003Eexit()\u003C\u002Fcode\u003E. В идеале, стоит избегать этих механизмов, когда где-то рядом исполняется FFI код.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"ochischaem-pamyat-dazhe-v-sluchae-dieexit\"\u003EОчищаем память даже в случае die\u002Fexit\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ KPHP нет деструкторов, поэтому единственное, что нас может спасти от внезапного прекращения работы скрипта — это функция, регистрируемая через \u003Ca href=\"https:\u002F\u002Fwww.php.net\u002Fmanual\u002Fen\u002Ffunction.register-shutdown-function.php\" rel=\"nofollow noopener noreferrer\"\u003Eregister_shutdown_function\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПоскольку регистрировать на каждый объект, который мы хотим автоматически финализировать, новую shutdown функцию — это расточительно, рекомендуется использовать пакет \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKFinalize\" rel=\"nofollow noopener noreferrer\"\u003EKFinalize\u003C\u002Fa\u003E. Этот пакет позволяет сохранить список финализаторов, которые будут запущены внутри одной shutdown функции.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИменно через этот механизм и работает автоматический \u003Ccode\u003Eclose()\u003C\u002Fcode\u003E объектов \u003Ccode\u003EKSQLite\u003C\u002Fcode\u003E. При создании нового экземпляра, мы добавляем лямбду-финализатор в список \u003Ccode\u003EKFinalize\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРассмотрим следующий пример кода:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E$query = 'SELECT 10 AS value';\n$db-\u003Efetch($query, [], function(KSQLiteQueryContext $ctx) {\n  if (some_cond()) {\n    die(\"exiting right from the callback\\n\");\n  }\n  return 0;\n});\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВся модель очистки ресурсов KSQLite построена на том, что объекты создаются и освобождаются вне вашего кода. Вот как исполняется \u003Ccode\u003Efetch\u003C\u002Fcode\u003E (упрощённо):\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EСоздаётся SQLite3 stmt\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗапускается SQLite3 step\u003C\u002Fli\u003E\r\n\u003Cli\u003EВызывается предоставленная функция\u003C\u002Fli\u003E\r\n\u003Cli\u003EКогда данных больше нет, SQLite3 stmt очищается\u003C\u002Fli\u003E\r\n\u003Cli\u003EИз \u003Ccode\u003Efetch\u003C\u002Fcode\u003E возвращается результат\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПользовательская функция вызывается в блоке try\u002Fcatch, поэтому исключения не помешают корректной очистке ресурсов. Само исключение будет повторно запущено после очистки ресурсов запроса.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЕсли же на шаге 3 произойдёт \u003Ccode\u003Eexit()\u003C\u002Fcode\u003E, то мы никогда не перейдём к следующим шагам. Память, выделенная нативной библиотекой никогда не будет освобождена, потому что KPHP (и PHP) рантаймы ничего о ней не знают.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТем не менее выход есть. В классе KSQLite хранится список активных stmt объектов. Как только выделяется новый объект SQLite stmt, мы добавляем его в список. Затем мы исполняем алгоритм, как и раньше. Перед очищением памяти мы делаем \u003Ccode\u003Earray_pop\u003C\u002Fcode\u003E из этого списка. В простейшем сценарии, этот список почти всегда содержит от 0 до 1 элементов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ нашем \"деструкторе\", который мы регистрируем для объекта KSQLite через KFinalize, мы обходим список активных объектов данного коннектора и финализируем их. Если никаких exit\u002Fdie не было, то этот список будет пустым.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВот так выглядит деструктор для KSQLite:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003EKFinalize::push(function() {\n  foreach ($this-\u003Eactive_stmt_list as $stmt) {\n    $this-\u003Elib-\u003Esqlite3_finalize($stmt);\n  }\n  \u002F\u002F Вызывать close() безопасно даже если пользователь\n  \u002F\u002F вызывал его до этого вручную.\n  $this-\u003Eclose();\n});\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"proizvoditelnost-ksqlite\"\u003EПроизводительность KSQLite\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТесты производительности здесь нужны для того, чтобы понять, насколько FFI библиотеки могут сравниться по эффективности с нативными расширениями для PHP. FFI — это единственный на данный момент способ использовать C библиотеки из KPHP, поэтому логично включить в сравнение и этот пункт.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНагрузочное тестирование будем проводить следующим образом:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EВ качестве работающего приложения возьмём \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002Fexamples\u002Fsimple_site.php\" rel=\"nofollow noopener noreferrer\"\u003EKSQLite\u002Fexamples\u002Fsimple_site\u003C\u002Fa\u003E.\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗапускать PHP будем через \u003Ccode\u003Enginx\u003C\u002Fcode\u003E + \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EПодавать нагрузку и измерять RPS будем через \u003Ccode\u003Eab\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСервер и воркеры будут работать на выделенных ядрах\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003Eab\u003C\u002Fcode\u003E будет работать на других выделенных ядрах\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПодробнее о методике читайте под спойлерами ниже.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"scrollable-table\"\u003E\u003Ctable\u003E\r\n\u003Cthead\u003E\r\n\u003Ctr\u003E\r\n\u003Cth\u003ETest\u003C\u002Fth\u003E\r\n\u003Cth\u003ERequests\u002Fsec\u003C\u002Fth\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003C\u002Fthead\u003E\r\n\u003Ctbody\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EPHP7.4 FFI\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E5694\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EPHP7.4 ext\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E6415\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EPHP8.1 FFI\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E6147\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EPHP8.1 ext\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E6673\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EKPHP FFI\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E9010\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003C\u002Ftbody\u003E\r\n\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EKSQLite на данный момент не содержит никаких оптимизаций для частных случаев. Даже простой \u003Ccode\u003Eexec()\u003C\u002Fcode\u003E, которого в производимых бенчмарках много, выполняет лишнюю работу. В FFI вариантах мы получаем больше интерпретируемого PHP кода: часть логики \u003Ccode\u003Eexec()\u003C\u002Fcode\u003E реализована на самом PHP, а не на C.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EБлагодаря компиляции и информации о типах, вызовы из KPHP в C гораздо дешевле. Помогает и тот факт, что KPHP транслируется в C++, а из C++ легко можно вызывать C функции.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EPHP8.1 оказался быстрее PHP7.4 на \u003Ccode\u003E~5%\u003C\u002Fcode\u003E (JIT включен)\u003C\u002Fli\u003E\r\n\u003Cli\u003EKSQLite для PHP медленнее на \u003Ccode\u003E~10%\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EKPHP с FFI в этом тесте на \u003Ccode\u003E~25%\u003C\u002Fcode\u003E быстрее чем, PHP8.1 ext\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EДополнительная информация об окружении\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EKPHP собран с коммита \u003Ccode\u003E1e584607616e237bc0abcc0e989e0a1725a08b68\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ php7.4 --version\nPHP 7.4.3 (cli) (built: Nov 25 2021 23:16:22) ( NTS )\n\n$ php8.1 --version\nPHP 8.1.3 (cli) (built: Feb 21 2022 14:48:42) (NTS)\n\n$ php8.1 -i | grep JIT\nPCRE JIT Support =\u003E enabled\nPCRE JIT Target =\u003E x86 64bit (little endian + unaligned)\nJIT =\u003E On\n\n$ sqlite3 --version\n3.31.1 2020-01-27\n\n$ nginx -v\nnginx version: nginx\u002F1.18.0 (Ubuntu)\n\n$ ab -V\nThis is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $\u003E\n\n$ uname -a\nLinux kphpbook 5.14.0-1024-oem 26-Ubuntu SMP Thu Feb 17 2022 x86_64 GNU\u002FLinux\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ lscpu\nArchitecture:       x86_64\nCPU op-mode(s):     32-bit, 64-bit\nByte Order:         Little Endian\nAddress sizes:      39 bits physical, 48 bits virtual\nCPU(s):             8\nThread(s) per core: 2\nCore(s) per socket: 4\nSocket(s):          1\nNUMA node(s):       1\nVendor ID:          GenuineIntel\nCPU family:         6\nModel:              140\nModel name:         11th Gen Intel(R) Core(TM) i7-1165G7 @ 2.80GHz\nStepping:           1\nCPU MHz:            2800.000\nCPU max MHz:        4700,0000\nCPU min MHz:        400,0000\nL1d cache:          192 KiB\nL1i cache:          128 KiB\nL2 cache:           5 MiB\nL3 cache:           12 MiB\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EКак запускались бенчмарки\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EОтключаем turbo boost (снижает RPS, но увеличивает точность измерений):\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ echo \"1\" | sudo tee \u002Fsys\u002Fdevices\u002Fsystem\u002Fcpu\u002Fintel_pstate\u002Fno_turbo\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПодготавливаем \u003Ccode\u003Enginx\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# Сохраняем pid работающего мастер-процесса nginx:\n$ nginx_pid=$(ps -aux | grep nginx | grep master | awk '{print $2}')\n# Пытаемся закрепить nginx за ядрами 2, 3 и 4:\n$ sudo taskset -cp 2-4 $nginx_pid\n# Аналогично для всех worker-процессов:\n$ nginx_workers=$(cat \u002Fproc\u002F$nginx_pid\u002Ftask\u002F$nginx_pid\u002Fchildren)\n$ for pid in $nginx_workers ; do sudo taskset -cp 2-4 $pid ; done\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EKPHP для тестов запускать так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# У nginx на моей машине 8 воркеров, поэтому и в KPHP укажем это значение.\n# Воркер-процессы, создаваемые веб-сервером, унаследуют параметры,\n# выставляемые через taskset.\n$ taskset -c 2-4 .\u002Fkphp_out\u002Fserver --http-port 9000 --workers-num 8\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EА нагрузку подаём скриптом с ядер 5, 6 и 7:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ taskset -c 5-7 \\\n    ab -T 'application\u002Fx-www-form-urlencoded' \\\n       -n 5000 \\\n       -c 4 \\\n       -p post.data \\\n       http:\u002F\u002Flocalhost:9001\u002F\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"php-fpm--ffi-preloading\"\u003Ephp-fpm + FFI preloading\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля того, чтобы PHP не разбирал заголовочные файлы на каждом запросе, рекомендуется использовать \u003Ccode\u003EFFI::scope\u003C\u002Fcode\u003E. Воспользоваться им можно только если нужные файлы были загружены на этапе opcache preload.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы вся эта связка работала, надо подкрутить настройки нашего PHP.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E\u003Ccode\u003EFFI::load\u003C\u002Fcode\u003E для регистрации в scope мы должны делать в preload контексте\u003C\u002Fli\u003E\r\n\u003Cli\u003EМастер-процесс \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E должен быть запущен не от рута\u003C\u002Fli\u003E\r\n\u003Cli\u003EНельзя использовать \u003Ccode\u003Eopcache.preload_user\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭти пункты взаимосвязаны. \u003Ccode\u003Eopcache.preload\u003C\u002Fcode\u003E потребует указания \u003Ccode\u003Eopcache.preload_user\u003C\u002Fcode\u003E, если \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E работает от рута. Если мы добавим в конфиг \u003Ccode\u003Eopcache.preload_user\u003C\u002Fcode\u003E, у нас перестанет работать \u003Ccode\u003EFFI::load\u003C\u002Fcode\u003E внутри скрипта предзагрузки (на это неожиданное поведение даже заведён \u003Ca href=\"https:\u002F\u002Fbugs.php.net\u002Fbug.php?id=79232&amp;edit=3\" rel=\"nofollow noopener noreferrer\"\u003Eтикет\u003C\u002Fa\u003E).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВариантов не очень много. \u003Ca href=\"https:\u002F\u002Fwww.reddit.com\u002Fr\u002FPHP\u002Fcomments\u002Fezi8ne\u002Fofficial_ffipreload_example_is_broken\u002F\" rel=\"nofollow noopener noreferrer\"\u003EВ одном из обсуждений\u003C\u002Fa\u003E на reddit можно найти подсказку к тому, как получить рабочее решение.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНам нужно выполнить пункт \u003Ccode\u003E(2)\u003C\u002Fcode\u003E и тогда все остальные будут выполнены без проблем, ведь \u003Ccode\u003Eopcache.preload_user\u003C\u002Fcode\u003E требуется только для рута.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРешение будет зависеть от системы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа моей Ubuntu нужно было отредактировать:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ccode\u003E\u002Flib\u002Fsystemd\u002Fsystem\u002Fphp7.4-fpm.service\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003E\u002Flib\u002Fsystemd\u002Fsystem\u002Fphp8.1-fpm.service\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ секцию \u003Ccode\u003E[Service]\u003C\u002Fcode\u003E добавляем \u003Ccode\u003EUser\u003C\u002Fcode\u003E и \u003Ccode\u003EGroup\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"diff\"\u003E[Service]\n+ User=www-data\n+ Group=www-data\n  Type=notify\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДалее можно попробовать перезапустить сервис \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E, но, скорее всего, нужно будет ещё поменять владельцев всех файлов и каталогов в корне сайта.\u003Cbr\u002F\u003E\r\nУсловного \u003Ccode\u003Echown -R www-data ~\u002Fwww\u003C\u002Fcode\u003E будет достаточно.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМне так же потребовалось поменять владельца файла логов \u003Ccode\u003E\u002Fvar\u002Flog\u002Fphp7.4-fpm.log\u003C\u002Fcode\u003E, но наверняка есть какой-то способ попросить \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E записывать логи в какое-то другое место, куда у пользователя будет более простой доступ.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь непосредственно к самому preload скрипту. Поскольку мы ожидаем, что все FFI библиотеки будут доступны по относительному пути, мы должны запускать \u003Ccode\u003EFFI::load\u003C\u002Fcode\u003E из нужной директории. В случае CLI рабочая директория будет предсказуемая, а вот \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E может запустить скрипт предзагрузки с самого корня (\u003Ccode\u003E\u002F\u003C\u002Fcode\u003E). Чтобы сделать preload скрипт более независимым от рабочей директории, можно переходить в нужное место из самого скрипта.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ проекте KSQLite файлы располагаются так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eexamples\u002F\n  preload.php\n  simple_site.php\nffilibs\u002F\n  libsqlite3\nsrc\u002F\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСледовательно, \u003Ccode\u003Effilibs\u003C\u002Fcode\u003E находится на уровень выше относительно \u003Ccode\u003Epreload.php\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E\u002F\u002F Если бы preload.php находился в корне, здесь был бы просто __DIR__.\n$root_path = __DIR__ . '\u002F..\u002F';\nif (!chdir($root_path)) {\n  throw new Exception(\"failed chdir to $root_path\\n\");\n}\n\u002F\u002F Запускаем тут все FFI::load от библиотек.\n\u002F\u002F Про договорённость Libname::loadFFI() читайте ниже.\nload_ffi_libs(); \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь мы можем легко запускать приложение как через CLI, встроенный веб-сервер PHP (\u003Ccode\u003E-S\u003C\u002Fcode\u003E), \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E, а также в режиме собранного KPHP бинарника (тоже CLI + server).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"testirovanie\"\u003EТестирование\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F452\u002Fef7\u002Fff0\u002F452ef7ff04ba330c1277db05bc368715.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F452\u002Fef7\u002Fff0\u002F452ef7ff04ba330c1277db05bc368715.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТестировать мы будем как на PHP, так и на KPHP, поэтому нам понадобятся сразу два пакета:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# phpunit мы используем для запуска тестов в PHP режиме\n$ composer require --dev phpunit\u002Fphpunit:9.5.16\n# kphpunit - это то, что реализует phpunit для KPHP\n$ composer require --dev vkcom\u002Fkphpunit:v1.0.0\n# Устанавливаем утилиту ktest для запусков KPHP тестов и бенчмарков\n$ composer require --dev vkcom\u002Fktest-script\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИсполнять тесты на обоих языках полезно, чтобы ловить некоторые нюансы различий поведения PHP и KPHP. А ещё это гарантирует, что типизация в проекте не сломалась.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим тестовый класс \u003Ccode\u003Etests\u002FKSQLiteTest.php\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E&lt;?php\n\nuse PHPUnit\\Framework\\TestCase;\n\nclass KSQLiteTest extends TestCase {\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗаполнять \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002Ftests\u002FKSQLiteTest.php\" rel=\"nofollow noopener noreferrer\"\u003Eвесь класс\u003C\u002Fa\u003E в рамках этой статьи мы не будем. Затронем лишь самые важные аспекты.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля создания, заполнения и очистки БД мы воспользуемся \u003Ccode\u003EsetUpBeforeClass\u003C\u002Fcode\u003E и \u003Ccode\u003EtearDownAfterClass\u003C\u002Fcode\u003E. Соединение с БД будем держать в статическом поле класса.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EУпрощённый код setUpBeforeClass и tearDownAfterClass\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"php\"\u003Eprivate static $db_filename = '';\nprivate static KSQLite $db;\nprivate static $coord_values = [];\n\npublic static function setUpBeforeClass(): void {\n  if (KPHP_COMPILER_VERSION) { KSQLite::loadFFI(); }\n\n  $tmp_dir = '\u002Ftmp'; \u002F\u002F или sys_get_temp_dir()\n  self::$db_filename = (string)tempnam($tmp_dir, 'testdb');\n\n  self::$db = new KSQLite();\n  if (!self::$db-\u003Eopen(self::$db_filename)) {\n    throw new \\Exception(self::$db-\u003EgetLastError());\n  }\n\n  \u002F\u002F Создаём тестовые таблицы.\n  $tables = [\n    'CREATE TABLE readonly_coord(\n      coord_id INTEGER PRIMARY KEY,\n      layer INTEGER DEFAULT 0 NOT NULL,\n      x REAL NOT NULL,\n      y REAL NOT NULL\n    )',\n  ];\n  foreach ($tables as $q) {\n    if (!self::$db-\u003Eexec($q)) {\n      throw new \\Exception(self::$db-\u003EgetLastError());\n    }\n  }\n\n  $values = [\n    [142.5, 218.0],\n    [0.0, 0.0],\n    [1.0, 1.0],\n  ];\n  \u002F\u002F Значения нам понадобятся чтобы потом сравнивать\n  \u002F\u002F результаты выборок в тестах.\n  foreach ($values as $i =\u003E $c) {\n    [$x, $y] = $c;\n    self::$coord_values[] = [\n      'x' =\u003E $x,\n      'y' =\u003E $y,\n    ];\n  }\n  $q = 'INSERT INTO readonly_coord(x, y) VALUES(?, ?)';\n  $bind_fn = function(KSQLiteParamsBinder $b) use ($values) {\n    return $b-\u003EbindFromList($values);\n  }\n  $ok = self::$db-\u003EexecPrepared($q, $bind_fn);\n  if (!$ok) {\n    throw new \\Exception(self::$db-\u003EgetLastError());\n  }\n}\n\npublic static function tearDownAfterClass(): void {\n  self::$db-\u003Eclose();\n  unlink(self::$db_filename);\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ написании самих тестов нет никаких особенностей. Обычные phpunit тесты.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003Epublic function testFetchColumn() {\n  $tests = [\n    0,\n    102,\n    4.25,\n    'str value',\n    '\"str value with quotes\"',\n    null,\n  ];\n  $query = 'SELECT :x';\n  foreach ($tests as $x) {\n    $params = [':x' =\u003E $x];\n    [$col, $ok] = self::$db-\u003EfetchColumn($query, $params);\n    $this-\u003EassertTrue($ok);\n    $this-\u003EassertSame($col, $x);\n  }\n\n  $query = 'SELECT COUNT(*) FROM readonly_coord';\n  [$count, $ok] = self::$db-\u003EfetchColumn($query);\n  $this-\u003EassertTrue($ok);\n  $this-\u003EassertSame($count, count(self::$coord_values));\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗапуск phpunit для PHP:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ php -d opcache.enable_cli=true \\\n      -d opcache.preload=preload.php \\\n      .\u002Fvendor\u002Fbin\u002Fphpunit \\\n      --bootstrap vendor\u002Fautoload.php tests\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗапуск ktest (kphpunit) для KPHP:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E$ .\u002Fvendor\u002Fbin\u002Fktest phpunit --enable-ffi tests\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа остальные вопросы по тестированию ответят исходники KSQLite:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002FMakefile\" rel=\"nofollow noopener noreferrer\"\u003EMakefile\u003C\u002Fa\u003E содержит команды \u003Ccode\u003Emake test\u003C\u002Fcode\u003E и \u003Ccode\u003Emake ci-test\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002F.github\u002Fworkflows\u002Fphp.yml\" rel=\"nofollow noopener noreferrer\"\u003E.github\u002Fworkflows\u002Fphp.yml\u003C\u002Fa\u003E описывает workflow для запуска тестов\u003C\u002Fli\u003E\r\n\u003Cli\u003EПримеры (examples) можно превратить в тесты, см. \u003Ccode\u003Ektest compare\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EЯ рекомендую ознакомиться со статьёй \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fvk\u002Fblog\u002F572424\u002F\"\u003EЗаметки KPHP: тестирование и бенчмарки\u003C\u002Fa\u003E. Там тема тестирования KPHP затронута более полно.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"benchmarki\"\u003EБенчмарки\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКак уже упоминалось выше, KSQLite — это не многолетний код, который мог обрасти разнообразными оптимизациями. Многие функции можно ускорить.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо ускорять вслепую, руководствуясь только своей интуицией и предчувствием — это не самая эффективная методология. В худшем случае таким оптимизации могут сделать только хуже. Стоит производить хотя бы минимальные действия по проверке гипотезы — запускать бенчмарки.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим файл \u003Ccode\u003Ebenchmarks\u002FBenchmarkKSQLite.php\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E&lt;?php\n\nuse KSQLite\\KSQLite;\n\nclass BenchmarkKSQLite {\n  private KSQLite $db;\n\n  public function __construct() {\n    if (KPHP_COMPILER_VERSION) { KSQLite::loadFFI(); }\n    $this-\u003Edb = new KSQLite();\n    if (!$this-\u003Edb-\u003Eopen('benchdb')) {\n      throw new \\Exception($this-\u003Edb-\u003EgetLastError());\n    }\n  }\n\n  public function benchmarkExecSelect1() {\n    if (!$this-\u003Edb-\u003Eexec('SELECT 1')) {\n      throw new \\Exception($this-\u003Edb-\u003EgetLastError());\n    }\n  }\n\n  public function benchmarkFetchRowConst() {\n    [$_, $ok] = $this-\u003Edb-\u003EfetchRow(\"SELECT 1, 2.5, 'hello', null\");\n    if (!$ok) {\n      throw new \\Exception($this-\u003Edb-\u003EgetLastError());\n    }\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003Ektest позволяет запускать бенчмарки на PHP и KPHP. Это полезное свойство, ведь даже если приложение размещается на конечных серверах в виде KPHP бинарника, PHP часто используется для локального тестирования.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E# Запускаем бенчмарки на KPHP:\n$ .\u002Fvendor\u002Fbin\u002Fktest bench .\u002Fbenchmarks\nBenchmarkKSQLite::ExecSelect1   14740   5520.0 ns\u002Fop\nBenchmarkKSQLite::FetchCount    5340    16751.0 ns\u002Fop\nBenchmarkKSQLite::FetchRowConst 7640    12406.0 ns\u002Fop\nBenchmarkKSQLite::FetchOneRow   3380    29379.0 ns\u002Fop\nBenchmarkKSQLite::FetchAllRows  3720    27008.0 ns\u002Fop\nok BenchmarkKSQLite\n\n# Запускаем бенчмарки на PHP8.1:\n$ .\u002Fvendor\u002Fbin\u002Fktest bench-php --preload preload.php .\u002Fbenchmarks\nBenchmarkKSQLite::ExecSelect1   7760    12045.0 ns\u002Fop\nBenchmarkKSQLite::FetchCount    2720    27958.0 ns\u002Fop\nBenchmarkKSQLite::FetchRowConst 3860    23208.0 ns\u002Fop\nBenchmarkKSQLite::FetchOneRow   2080    41163.0 ns\u002Fop\nBenchmarkKSQLite::FetchAllRows  2400    40979.0 ns\u002Fop\nok BenchmarkKSQLite\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля удобного сравнения результатов бенчмарков PHP и KPHP есть команда \u003Ccode\u003Ebench-vs-php\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E.\u002Fvendor\u002Fbin\u002Fktest bench-vs-php --preload preload.php .\u002Fbenchmarks\nname                    PHP time\u002Fop  KPHP time\u002Fop  delta\nKSQLite::ExecSelect1    10.5µs ± 1%   5.5µs ± 3%  -47.95%\nKSQLite::FetchCount     28.0µs ± 1%  17.1µs ± 1%  -38.79%\nKSQLite::FetchRowConst  23.5µs ± 1%  11.5µs ± 1%  -50.82%\nKSQLite::FetchOneRow    40.8µs ± 1%  27.1µs ± 1%  -33.57%\nKSQLite::FetchAllRows   40.7µs ± 1%  26.5µs ± 1%  -35.07%\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПодробнее о бенчмарках можно почитать в уже \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fvk\u002Fblog\u002F572424\u002F\"\u003Eупомянутой выше статье\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"konvencii-dlya-ffi-paketov\"\u003EКонвенции для FFI пакетов\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ этой части кратко описаны основные концепции, вводимые в статье.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EОпциональный текст\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Ch3 id=\"metod-loadffi\"\u003EМетод loadFFI\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПоскольку контексты загрузки могут отличаться для KPHP и PHP, стоит предоставить вызов инициализации в руки пользователей. В основном классе библиотеки определяем статический метод \u003Ccode\u003EloadFFI()\u003C\u002Fcode\u003E, который выполнит \u003Ccode\u003EFFI::load()\u003C\u002Fcode\u003E на все файлы, связанные с библиотекой.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003Epublic static function loadFFI(): bool {\n  return \\FFI::load(__DIR__ . '\u002Fsqlite.h') !== null;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ KPHP вы будете вызывать этот метод где-то в начале скрипта, который является точкой входа в приложение:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003Eif (KPHP_COMPILER_VERSION) {\n  KSQLite::loadFFI();\n  SomeOtherLib::loadFFI();\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ PHP это будет preload скрипт с такими же вызовами, но без проверки на KPHP_COMPILER_VERSION:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E&lt;?php\n\nrequire_once __DIR__ . '\u002Fautoload.php'\n\nKSQLite::loadFFI();\nSomeOtherLib::loadFFI();\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПочему это важно:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EМеньше беспорядка при использовании нескольких FFI библиотек\u003C\u002Fli\u003E\r\n\u003Cli\u003EКонтроль над контекстом, в котором исполняется \u003Ccode\u003EFFI::load\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"opcachepreload-i-chdir\"\u003Eopcache.preload и chdir\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ предыдущем примере мы использовали методы \u003Ccode\u003EloadFFI()\u003C\u002Fcode\u003E, но есть нюанс, который мы не затронули. В зависимости от приложения, \u003Ccode\u003Epreload.php\u003C\u002Fcode\u003E может лежать в разных местах. Сам же скрипт тоже может запускаться из разных директорий.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"php\"\u003E\u002F\u002F Если бы preload.php находился в корне, здесь был бы просто __DIR__.\n$root_path = __DIR__ . '\u002F..\u002F';\nif (!chdir($root_path)) {\n  throw new Exception(\"failed chdir to $root_path\\n\");\n}\nKSQLite::loadFFI();\nSomeOtherLib::loadFFI();\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПочему это важно:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EМожно вызывать скрипт из любой директории\u003C\u002Fli\u003E\r\n\u003Cli\u003EЭта схема работает как для CLI, так и для \u003Ccode\u003Ephp-fpm\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"ffi_lib\"\u003EFFI_LIB\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПуть в \u003Ccode\u003E#define FFI_LIB\u003C\u002Fcode\u003E пишем относительный, через каталог \u003Ccode\u003Effilibs\u003C\u002Fcode\u003E. Никакого платформенного расширения, типа \u003Ccode\u003E.so\u003C\u002Fcode\u003E мы не указываем.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E#define FFI_LIB \".\u002Fffilibs\u002Flibsqlite3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля удобства, рекомендуется предоставлять аналог скрипта \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\u002Fblob\u002Fmaster\u002Flocate_lib.php\" rel=\"nofollow noopener noreferrer\"\u003Elocate_lib.php\u003C\u002Fa\u003E, чтобы пользователям было проще правильно установить библиотеку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПочему это важно:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EПроще инструкции установки. Везде идентичные (Windows, MacOS, Linux)\u003C\u002Fli\u003E\r\n\u003Cli\u003EМожно легко переносить директорию с проектом между машинами\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ccode\u003Effilibs\u003C\u002Fcode\u003E может быть ссылкой на какую-то системную папку \u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"izbegaem-utechek-pamyati\"\u003EИзбегаем утечек памяти\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСамостоятельно удалять объекты, созданные через \u003Ccode\u003EFFI::new\u003C\u002Fcode\u003E не нужно.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОчистки или финализации требуют те объекты, что инициализируются внутри C кода. Эти аллокации могут либо менять внутреннее состояние библиотеки, либо использовать системный аллокатор. В любом из этих случаев, нам надо самостоятельно вызвать C функцию-деструктор, предоставляемую библиотекой.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВот несколько рекомендаций:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EИспользуйте \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKFinalize\" rel=\"nofollow noopener noreferrer\"\u003EKFinalize\u003C\u002Fa\u003E для эмуляции деструкторов\u003C\u002Fli\u003E\r\n\u003Cli\u003EЕсли можно инкапсулировать финализируемые объекты — сделайте это\u003C\u002Fli\u003E\r\n\u003Cli\u003EПроектируйте такое API, которое сложно использовать неправильно\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОбработка ошибок должна быть консистентной и предсказуемой. Исключения могут быть неожиданными — пользователь должен быть к ним готов, чтобы на месте получения исключения освободить ресурсы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПочему это важно:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EВ режиме работы сервера, небольшая утечка становится большой через пару тысяч запросов\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"zaklyuchenie\"\u003EЗаключение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПопробуйте \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002FKSQLite\" rel=\"nofollow noopener noreferrer\"\u003EKSQLite\u003C\u002Fa\u003E на PHP, а потом запустите его на KPHP.\u003Cbr\u002F\u003E\r\nСоздавайте свои FFI библиотеки и \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002Fawesome-kphp.git\" rel=\"nofollow noopener noreferrer\"\u003Eделитесь ими\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЕсли у вас остались какие-то вопросы по KSQLite или FFI в KPHP — прошу в комментарии.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"poleznye-ssylki\"\u003EПолезные ссылки\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fquasilyte\u002Fawesome-kphp.git\" rel=\"nofollow noopener noreferrer\"\u003Eawesome-kphp\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Ft.me\u002Fkphp_chat\" rel=\"nofollow noopener noreferrer\"\u003EНеофициальный чат KPHP-сообщества\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтатья \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fvk\u002Fblog\u002F581238\u002F\"\u003EСоздаём игру на KPHP с помощью FFI и SDL\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтатья \u003Ca href=\"https:\u002F\u002Fphp.zone\u002Fpost\u002Fkphp-in-life\" rel=\"nofollow noopener noreferrer\"\u003EПробуем KPHP: реально ли его использовать в своих проектах\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтатья \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fvk\u002Fblog\u002F572424\u002F\"\u003EЗаметки KPHP: тестирование и бенчмарки\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтатья \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fvk\u002Fblog\u002F527420\u002F\"\u003EВКонтакте снова выкладывает KPHP\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"kphp"},{"titleHtml":"php"},{"titleHtml":"sqlite"},{"titleHtml":"ffi"},{"titleHtml":"ksqlite"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F653677\u002Fbc75c868bcb4bbc0256bca68d91ac4c8\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F653677\u002Fbc75c868bcb4bbc0256bca68d91ac4c8\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F653677\\\u002F\"},\"headline\":\"Используем SQLite в KPHP и PHP через FFI\",\"datePublished\":\"2022-03-11T17:53:06+03:00\",\"dateModified\":\"2022-03-11T17:53:06+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Искандер\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP. Создавать FFI пакеты &mdash; не просто. Под катом будут ответы на сл...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F653677\\\u002F#post-content-body\",\"about\":[\"h_webdev\",\"h_open_source\",\"h_php\",\"h_programming\",\"h_sqlite\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fbo\\\u002Fnc\\\u002Fpi\\\u002Fboncpiokbph5gehyjnsqycl_78i.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fys\\\u002Fm6\\\u002Fxe\\\u002Fysm6xens23eqrhj0h7_53khn8ni.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F452\\\u002Fef7\\\u002Fff0\\\u002F452ef7ff04ba330c1277db05bc368715.png\"]}","metaDescription":"Сегодня я расскажу о новой библиотеке, которая позволяет использовать SQLite сразу из PHP и KPHP.\r\nСоздавать FFI пакеты — не просто. Под катом будут ответы на следующие вопросы:\r\n\r\nКак упростить...","mainImageUrl":null,"amp":false,"customTrackerLinks":[]},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[{"title":"PHP программист","vacanciesCount":216,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fphp_programmist","itemHubs":["laravel","symfony","yii","php"]},{"title":"Разработчик Laravel","vacanciesCount":79,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fprogrammist_laravel","itemHubs":["laravel","php"]}],"hubs":"webdev,open_source,php,programming,sqlite"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"technotext":{"nominationsList":[]},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script> 
  <script src="https://assets.habr.com/habr-web/js/chunk-vendors.55ca5167.js" defer></script>
  <script src="https://assets.habr.com/habr-web/js/app.69ba180e.js" defer></script> 
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script> 
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script> 
  <noscript> 
   <div> 
    <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt=""> 
   </div> 
  </noscript> 
  <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script> 
  <script src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true"></script>  
 </body>
</html>